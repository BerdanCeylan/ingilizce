<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Watch Together - Film Ä°zle Beraber</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}?v=4">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
    <div class="container" style="padding-top: 60px;">
        <header style="position: relative; overflow: visible;">
            <h1>ğŸ¬ Watch Together - Film Ä°zle Beraber</h1>
            <p>ArkadaÅŸlarÄ±nÄ±zla beraber film izleyin, sohbet edin ve ekran paylaÅŸÄ±n</p>
        </header>

        <main>
            <!-- Login Section -->
            <section id="loginSection" class="section active">
                <div class="login-container">
                    <div class="login-card">
                        <div class="login-header">
                            <h2>ğŸ¬ HoÅŸ Geldiniz!</h2>
                            <p>Ä°ngilizce Ã¶ÄŸrenme yolculuÄŸunuza baÅŸlayÄ±n</p>
                        </div>
                        
                        <form id="loginForm" class="login-form">
                            <div class="form-field">
                                <label for="username">
                                    <span class="icon">ğŸ‘¤</span>
                                    KullanÄ±cÄ± AdÄ±
                                </label>
                                <input type="text" id="username" placeholder="KullanÄ±cÄ± adÄ±nÄ±zÄ± girin" autocomplete="username">
                            </div>
                            
                            <div class="form-field">
                                <label for="password">
                                    <span class="icon">ğŸ”’</span>
                                    Åifre
                                </label>
                                <input type="password" id="password" placeholder="Åifrenizi girin" autocomplete="current-password">
                                <button type="button" class="password-toggle" id="passwordToggle" aria-label="Åifreyi gÃ¶ster/gizle">
                                    ğŸ‘ï¸
                                </button>
                            </div>
                            
                            <div class="form-options">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="rememberMe">
                                    <span>Beni HatÄ±rla</span>
                                </label>
                                <a href="#" class="forgot-password">Åifremi Unuttum</a>
                            </div>
                            
                            <div class="auth-buttons">
                                <button type="button" id="loginBtn" class="btn btn-primary btn-large">
                                    <span class="btn-icon">ğŸš€</span>
                                    GiriÅŸ Yap
                                </button>
                                <button type="button" id="registerBtn" class="btn btn-secondary btn-large">
                                    <span class="btn-icon">âœ¨</span>
                                    KayÄ±t Ol
                                </button>
                            </div>
                        </form>
                        
                        <div class="divider">
                            <span>veya</span>
                        </div>
                        
                        <div class="social-auth">
                            <div id="googleBtnContainer" class="google-signin-container"></div>
                            <p class="social-auth-note">Google hesabÄ±nÄ±zla hÄ±zlÄ±ca giriÅŸ yapÄ±n</p>
                        </div>
                        
                        <div id="loginError" class="error-message" style="display: none;"></div>
                        <div id="loginSuccess" class="success-message" style="display: none;"></div>
                    </div>
                </div>
            </section>

            <!-- Main App Section -->
            <section id="appSection" class="section" style="display: none;">
                <div class="tabs">
                    <button class="tab-btn active" data-tab="rooms">ğŸ¬ Odalar</button>
                    <button class="tab-btn" data-tab="watch">ğŸ“º Film Ä°zle</button>
                    <button class="tab-btn" data-tab="profile">ğŸ‘¤ Profil</button>
                </div>

                <!-- Rooms Tab -->
                <div id="roomsTab" class="tab-content active">
                    <div class="card">
                        <h2>Yeni Oda OluÅŸtur</h2>
                        <div class="form-group">
                            <input type="text" id="roomName" placeholder="Oda adÄ±" value="Benim OdasÄ±">
                            <input type="text" id="videoUrl" placeholder="Video URL (YouTube)">
                            <input type="text" id="videoTitle" placeholder="Video BaÅŸlÄ±ÄŸÄ±">
                            <button id="createRoomBtn" class="btn btn-primary">Oda OluÅŸtur</button>
                        </div>
                    </div>

                    <div class="card">
                        <h2>Aktif Odalar</h2>
                        <div id="roomsList" class="rooms-grid">
                            <p>Odalar yÃ¼kleniyor...</p>
                        </div>
                    </div>
                </div>

                <!-- Watch Tab -->
                <div id="watchTab" class="tab-content" style="display: none;">
                    <!-- Series Selection Section -->
                    <div class="card">
                        <h2>ğŸ“º Dizi SeÃ§imi</h2>
                        <p style="color: #666; font-size: 0.9em; margin-bottom: 15px;">Bir veya birden fazla dizi seÃ§in, kelime haritasÄ±nÄ± oluÅŸturun ve bÃ¶lÃ¼mleri gÃ¶rÃ¼ntÃ¼leyin</p>
                        
                        <div style="display: flex; gap: 20px; flex-wrap: wrap; justify-content: center; margin-bottom: 20px;">
                            <!-- Friends Poster -->
                            <div class="series-card" data-series="friends" style="cursor: pointer; text-align: center; transition: transform 0.3s; position: relative; border: 2px solid transparent;">
                                <label style="position: absolute; top: 10px; right: 10px; cursor: pointer; z-index: 10;">
                                    <input type="checkbox" class="series-checkbox" data-series="friends" style="width: 20px; height: 20px; cursor: pointer;">
                                </label>
                                <div style="width: 150px; height: 225px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin: 0 auto 10px; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);">
                                    <span style="font-size: 3em;">ğŸ‘«</span>
                                </div>
                                <h3 style="margin: 0; font-size: 1.1em;">Friends</h3>
                                <p style="color: #666; font-size: 0.8em; margin: 5px 0 0;">1994-2004</p>
                            </div>
                            
                            <!-- Big Bang Theory Poster -->
                            <div class="series-card" data-series="bigbang" style="cursor: pointer; text-align: center; transition: transform 0.3s; position: relative; border: 2px solid transparent;">
                                <label style="position: absolute; top: 10px; right: 10px; cursor: pointer; z-index: 10;">
                                    <input type="checkbox" class="series-checkbox" data-series="bigbang" style="width: 20px; height: 20px; cursor: pointer;">
                                </label>
                                <div style="width: 150px; height: 225px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin: 0 auto 10px; box-shadow: 0 4px 15px rgba(245, 87, 108, 0.4);">
                                    <span style="font-size: 3em;">ğŸ§ </span>
                                </div>
                                <h3 style="margin: 0; font-size: 1.1em;">Big Bang Theory</h3>
                                <p style="color: #666; font-size: 0.8em; margin: 5px 0 0;">2007-2019</p>
                            </div>
                            
                            <!-- Custom Series Container - will be populated dynamically -->
                            <div id="customSeriesContainer" style="display: contents;"></div>
                            
                            <!-- Add New Series Card -->
                            <div class="series-card add-new-series" onclick="openAddSeriesModal()" style="cursor: pointer; text-align: center; transition: transform 0.3s; position: relative; border: 2px dashed #cbd5e1;">
                                <div style="width: 150px; height: 225px; background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin: 0 auto 10px; box-shadow: 0 4px 15px rgba(148, 163, 184, 0.2);">
                                    <span style="font-size: 4em; color: #94a3b8;">+</span>
                                </div>
                                <h3 style="margin: 0; font-size: 1.1em; color: #64748b;">Yeni Ekle</h3>
                                <p style="color: #94a3b8; font-size: 0.8em; margin: 5px 0 0;">YouTube / Video URL</p>
                            </div>
                        </div>
                        
                        <!-- Build Word Map Button -->
                        <div style="text-align: center; margin-bottom: 20px;">
                            <button id="buildWordMapBtn" class="btn btn-primary btn-large" onclick="buildCombinedWordMap()" disabled>
                                <span class="btn-icon">ğŸ—ºï¸</span>
                                SeÃ§ili Dizilerin Kelime HaritasÄ±nÄ± OluÅŸtur
                            </button>
                            <p id="selectedSeriesText" style="margin-top: 10px; color: #666; font-size: 0.9em;"></p>
                        </div>
                        
                        <!-- Word Map Status -->
                        <div id="wordMapStatus" style="display: none; margin-top: 20px; padding: 15px; background: #f0fdf4; border-radius: 8px; border: 1px solid #86efac;">
                            <div id="wordMapStatusText" style="color: #15803d;"></div>
                        </div>
                        
                        <!-- Series Word Map Display -->
                        <div id="seriesWordMap" style="display: none; margin-top: 20px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
                                <h3 style="margin: 0;">ğŸ“Š Kelime HaritasÄ±</h3>
                                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                    <button id="translateAllWordsBtn" class="btn btn-secondary" onclick="translateAllWords()" title="Eksik Ã§evirileri tamamla">
                                        ğŸ”„ Eksik Ã‡evirileri Tamamla
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Translation Stats -->
                            <div id="translationStatsContainer" style="display: none; margin-bottom: 20px; padding: 15px; background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border-radius: 12px; border: 1px solid #7dd3fc;">
                                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                                    <div>
                                        <h4 style="margin: 0 0 5px; color: #0369a1; font-size: 1em;">ğŸŒ Ã‡eviri Durumu</h4>
                                        <p id="translationStatsText" style="margin: 0; color: #0c4a6e; font-size: 0.9em;">YÃ¼kleniyor...</p>
                                    </div>
                                    <div style="display: flex; gap: 15px; align-items: center;">
                                        <div style="text-align: center;">
                                            <div id="translatedWordsCount" style="font-size: 1.5em; font-weight: bold; color: #059669;">0</div>
                                            <div style="font-size: 0.75em; color: #6b7280;">Ã‡evrilmiÅŸ</div>
                                        </div>
                                        <div style="text-align: center;">
                                            <div id="untranslatedWordsCount" style="font-size: 1.5em; font-weight: bold; color: #dc2626;">0</div>
                                            <div style="font-size: 0.75em; color: #6b7280;">Ã‡evrilmemiÅŸ</div>
                                        </div>
                                        <div style="width: 150px;">
                                            <div style="background: #e5e7eb; height: 8px; border-radius: 4px; overflow: hidden;">
                                                <div id="translationProgressBar" style="background: linear-gradient(90deg, #10b981, #059669); height: 100%; width: 0%; transition: width 0.3s;"></div>
                                            </div>
                                            <div id="translationPercentage" style="text-align: center; font-size: 0.75em; color: #6b7280; margin-top: 2px;">0%</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Translation Progress (shown during translation) -->
                            <div id="translationProgress" style="display: none; margin-bottom: 20px; padding: 20px; background: #fef3c7; border-radius: 12px; border: 1px solid #fcd34d;">
                                <div style="display: flex; align-items: center; gap: 15px;">
                                    <div style="width: 30px; height: 30px; border: 3px solid #fcd34d; border-top-color: #f59e0b; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                                    <div>
                                        <h4 style="margin: 0; color: #92400e;">ğŸ¤– AI Ã‡eviri YapÄ±lÄ±yor...</h4>
                                        <p id="translationProgressText" style="margin: 5px 0 0; color: #a16207; font-size: 0.9em;">Kelimeler Ã§evriliyor, lÃ¼tfen bekleyin...</p>
                                    </div>
                                </div>
                                <style>@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }</style>
                            </div>
                            
                            <div id="seriesWordMapStats" class="word-stats-grid" style="margin-bottom: 20px;"></div>
                            <div id="seriesWordMapLevels" class="levels-grid"></div>
                        </div>
                    </div>

                    <!-- Episode Selection (Hidden by default) -->
                    <div class="card" id="episodeSelectionCard" style="display: none;">
                        <h2 id="selectedSeriesTitle">ğŸ“º BÃ¶lÃ¼m SeÃ§imi</h2>
                        
                        <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; align-items: center;">
                            <select id="seriesSeasonSelect" style="padding: 10px; border-radius: 8px; border: 1px solid #ddd; min-width: 150px;">
                                <option value="">Sezon SeÃ§in</option>
                            </select>
                            <select id="seriesEpisodeSelect" style="padding: 10px; border-radius: 8px; border: 1px solid #ddd; min-width: 200px;" disabled>
                                <option value="">Ã–nce Sezon SeÃ§in</option>
                            </select>
                            <button id="loadEpisodeFlashcardsBtn" class="btn btn-primary" disabled>
                                ğŸ§  Flash KartlarÄ± Getir
                            </button>
                            <button id="openTranscriptStudyBtn" class="btn btn-secondary" disabled onclick="openTranscriptStudyMode()">
                                ğŸ“– Transkript Ãœzerinden Ã‡alÄ±ÅŸ
                            </button>
                            <button id="downloadTranscriptsBtn" class="btn btn-secondary" disabled onclick="downloadSeasonTranscripts()" title="Bu sezonun tÃ¼m transkriptlerini indir">
                                â¬‡ï¸ Transkriptleri Ä°ndir
                            </button>
                        </div>
                        <div id="downloadProgress" style="display: none; padding: 10px; background: #fef3c7; border-radius: 8px; margin-bottom: 15px;">
                            <span id="downloadProgressText">Ä°ndiriliyor...</span>
                        </div>

                        <!-- Episode Info -->
                        <div id="episodeInfo" style="display: none; padding: 20px; background: #f8fafc; border-radius: 12px; margin-bottom: 20px;">
                            <div style="display: flex; gap: 20px; flex-wrap: wrap; margin-bottom: 20px;">
                                <div style="flex: 1; min-width: 200px;">
                                    <h3 id="episodeTitle" style="margin: 0 0 10px;">BÃ¶lÃ¼m BaÅŸlÄ±ÄŸÄ±</h3>
                                    <p id="episodeDescription" style="color: #666; margin: 0;">BÃ¶lÃ¼m aÃ§Ä±klamasÄ± buraya gelecek</p>
                                </div>
                                <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                                    <div style="text-align: center; padding: 10px 20px; background: #fff; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                        <div id="episodeWordCount" style="font-size: 1.5em; font-weight: bold; color: #667eea;">0</div>
                                        <div style="font-size: 0.8em; color: #666;">Kelime</div>
                                    </div>
                                    <div style="text-align: center; padding: 10px 20px; background: #fff; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                        <div id="episodeFlashcardCount" style="font-size: 1.5em; font-weight: bold; color: #f5576c;">0</div>
                                        <div style="font-size: 0.8em; color: #666;">Flash Kart</div>
                                    </div>
                                    <div style="text-align: center; padding: 15px 25px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 8px; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3); color: white;">
                                        <div id="episodeKnownCount" style="font-size: 2em; font-weight: bold;">0</div>
                                        <div style="font-size: 0.9em; opacity: 0.95;">âœ… BildiÄŸim Kelimeler</div>
                                    </div>
                                    <div style="text-align: center; padding: 15px 25px; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); border-radius: 8px; box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3); color: white;">
                                        <div id="episodeUnknownCount" style="font-size: 2em; font-weight: bold;">0</div>
                                        <div style="font-size: 0.9em; opacity: 0.95;">âŒ BilmediÄŸim Kelimeler</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Level Statistics -->
                            <div id="episodeLevelStats" style="display: none; margin-top: 20px; padding-top: 20px; border-top: 2px solid #e5e7eb;">
                                <h4 style="margin: 0 0 15px; color: #374151; font-size: 1.1em;">ğŸ“Š Seviye DaÄŸÄ±lÄ±mÄ±</h4>
                                <div id="levelStatsContainer" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px;">
                                    <!-- Level stats will be inserted here -->
                                </div>
                            </div>
                        </div>

                        <!-- Flashcards Section -->
                        <div id="flashcardsSection" style="display: none;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h3 style="margin: 0;">ğŸ§  Flash Kartlar</h3>
                                <div style="display: flex; gap: 10px;">
                                    <button id="shuffleFlashcardsBtn" class="btn btn-secondary">ğŸ”€ KarÄ±ÅŸtÄ±r</button>
                                    <button id="startFlashcardsBtn" class="btn btn-success">â–¶ï¸ BaÅŸlat</button>
                                </div>
                            </div>
                            
                            <!-- Flashcard Display - 3D Flip Card -->
                            <div id="flashcardContainer" style="perspective: 1000px; margin-bottom: 20px;">
                                <div id="flashcard" style="width: 100%; height: 280px; position: relative; cursor: pointer; transition: transform 0.6s; transform-style: preserve-3d;">
                                    <!-- Front Side - English Word -->
                                    <div id="flashcardFront" style="position: absolute; width: 100%; height: 100%; backface-visibility: hidden; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 16px; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);">
                                        <!-- Level Badge -->
                                        <div id="flashcardLevelBadge" style="position: absolute; top: 15px; right: 15px; background: rgba(255, 255, 255, 0.3); padding: 6px 14px; border-radius: 20px; font-size: 0.75em; font-weight: 700; backdrop-filter: blur(10px); display: none; z-index: 10; border: 1px solid rgba(255, 255, 255, 0.3); box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);"></div>
                                        
                                        <div id="flashcardWord" style="font-size: 2.5em; font-weight: bold; margin-bottom: 10px; text-align: center; padding: 0 20px;">Kelime</div>
                                        <div id="flashcardPronunciation" style="font-size: 1em; opacity: 0.9;"></div>
                                        <div id="flashcardFrequency" style="font-size: 0.85em; opacity: 0.7; margin-top: 15px;"></div>
                                        <p style="font-size: 0.8em; opacity: 0.7; margin-top: 20px;">ğŸ”„ TÃ¼rkÃ§e anlamÄ± iÃ§in tÄ±klayÄ±n</p>
                                    </div>
                                    
                                    <!-- Back Side - Turkish Definition -->
                                    <div id="flashcardBack" style="position: absolute; width: 100%; height: 100%; backface-visibility: hidden; transform: rotateY(180deg); background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 16px; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; box-shadow: 0 10px 30px rgba(16, 185, 129, 0.3);">
                                        <div style="font-size: 0.9em; opacity: 0.8; margin-bottom: 10px;">ğŸ‡¹ğŸ‡· TÃ¼rkÃ§e AnlamÄ±</div>
                                        <div id="flashcardDefinition" style="font-size: 2em; font-weight: bold; text-align: center; padding: 0 30px; line-height: 1.4;"></div>
                                        <p style="font-size: 0.8em; opacity: 0.7; margin-top: 25px;">ğŸ”„ Ä°ngilizce kelime iÃ§in tÄ±klayÄ±n</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Flashcard Controls -->
                            <div style="display: flex; justify-content: center; gap: 15px; margin-top: 20px;">
                                <button id="prevFlashcardBtn" class="btn btn-secondary" disabled>â—€ Ã–nceki</button>
                                <span id="flashcardCounter" style="display: flex; align-items: center; font-size: 1.1em; color: #666;">1 / 10</span>
                                <button id="nextFlashcardBtn" class="btn btn-secondary" disabled>Sonraki â–¶</button>
                            </div>

                            <!-- Mark as Known -->
                            <div style="display: flex; justify-content: center; gap: 15px; margin-top: 20px;">
                                <button id="markUnknownBtn" class="btn btn-danger" disabled>âŒ Bilmiyorum</button>
                                <button id="markKnownBtn" class="btn btn-success" disabled>âœ… Biliyorum</button>
                            </div>
                        </div>

                        <div id="noFlashcardsMessage" style="display: none; text-align: center; padding: 40px; color: #666;">
                            <p style="font-size: 1.2em;">ğŸ‰ Tebrikler!</p>
                            <p>TÃ¼m kelimeleri Ã¶ÄŸrendiniz!</p>
                        </div>
                    </div>

                    <!-- BÃ¶lÃ¼m Flashcard Ã‡alÄ±ÅŸma AlanÄ± (AyrÄ± BÃ¶lÃ¼m) -->
                    <div class="card" style="margin-top: 30px; border: 2px solid #667eea; background: linear-gradient(135deg, #f8fafc 0%, #e0e7ff 100%);">
                        <h2 style="margin-bottom: 20px; color: #667eea;">ğŸ“š BÃ¶lÃ¼m Flashcard Ã‡alÄ±ÅŸma AlanÄ±</h2>
                        <p style="color: #666; font-size: 0.9em; margin-bottom: 20px;">Bir dizi seÃ§in, sezon ve bÃ¶lÃ¼m seÃ§in, o bÃ¶lÃ¼me ait kelimelerin flashcard'larÄ±na Ã§alÄ±ÅŸÄ±n</p>
                        
                        <!-- Dizi SeÃ§imi (Burada) -->
                        <div style="display: flex; gap: 20px; margin-bottom: 25px; flex-wrap: wrap; justify-content: center;">
                            <div class="series-card-flashcard" data-series="friends" style="cursor: pointer; text-align: center; transition: transform 0.3s; padding: 15px; border-radius: 12px; background: #fff; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                                <div style="width: 120px; height: 180px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin: 0 auto 10px; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);">
                                    <span style="font-size: 2.5em;">ğŸ‘«</span>
                                </div>
                                <h3 style="margin: 0; font-size: 1em;">Friends</h3>
                                <p style="color: #666; font-size: 0.75em; margin: 5px 0 0;">1994-2004</p>
                            </div>
                            
                            <div class="series-card-flashcard" data-series="bigbang" style="cursor: pointer; text-align: center; transition: transform 0.3s; padding: 15px; border-radius: 12px; background: #fff; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                                <div style="width: 120px; height: 180px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin: 0 auto 10px; box-shadow: 0 4px 15px rgba(245, 87, 108, 0.4);">
                                    <span style="font-size: 2.5em;">ğŸ§ </span>
                                </div>
                                <h3 style="margin: 0; font-size: 1em;">Big Bang Theory</h3>
                                <p style="color: #666; font-size: 0.75em; margin: 5px 0 0;">2007-2019</p>
                            </div>
                            
                            <!-- Custom Series Container for Flashcards -->
                            <div id="customSeriesFlashcardContainer" style="display: contents;"></div>
                        </div>
                        
                        <!-- BÃ¶lÃ¼m SeÃ§imi (Burada) -->
                        <div id="episodeSelectionCardFlashcard" style="display: none;">
                            <h3 id="selectedSeriesTitleFlashcard" style="margin-bottom: 15px; color: #374151;">ğŸ“º BÃ¶lÃ¼m SeÃ§imi</h3>
                            
                            <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
                                <select id="seriesSeasonSelectFlashcard" style="padding: 10px; border-radius: 8px; border: 1px solid #ddd; min-width: 150px;">
                                    <option value="">Sezon SeÃ§in</option>
                                </select>
                                <select id="seriesEpisodeSelectFlashcard" style="padding: 10px; border-radius: 8px; border: 1px solid #ddd; min-width: 200px;" disabled>
                                    <option value="">Ã–nce Sezon SeÃ§in</option>
                                </select>
                                <button id="loadEpisodeFlashcardsBtnFlashcard" class="btn btn-primary" disabled>
                                    ğŸ§  Flash KartlarÄ± Getir
                                </button>
                                <button id="openTranscriptStudyBtnFlashcard" class="btn btn-secondary" disabled onclick="openTranscriptStudyMode()">
                                    ğŸ“– Transkript Ãœzerinden Ã‡alÄ±ÅŸ
                                </button>
                            </div>

                            <!-- Episode Info -->
                            <div id="episodeInfoFlashcard" style="display: none; padding: 20px; background: #fff; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                <div style="display: flex; gap: 20px; flex-wrap: wrap; margin-bottom: 20px;">
                                    <div style="flex: 1; min-width: 200px;">
                                        <h3 id="episodeTitleFlashcard" style="margin: 0 0 10px;">BÃ¶lÃ¼m BaÅŸlÄ±ÄŸÄ±</h3>
                                    </div>
                                    <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                                        <div style="text-align: center; padding: 10px 20px; background: #f8fafc; border-radius: 8px;">
                                            <div id="episodeWordCountFlashcard" style="font-size: 1.5em; font-weight: bold; color: #667eea;">0</div>
                                            <div style="font-size: 0.8em; color: #666;">Kelime</div>
                                        </div>
                                        <div style="text-align: center; padding: 15px 25px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 8px; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3); color: white;">
                                            <div id="episodeKnownCountFlashcard" style="font-size: 2em; font-weight: bold;">0</div>
                                            <div style="font-size: 0.9em; opacity: 0.95;">âœ… BildiÄŸim</div>
                                        </div>
                                        <div style="text-align: center; padding: 15px 25px; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); border-radius: 8px; box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3); color: white;">
                                            <div id="episodeUnknownCountFlashcard" style="font-size: 2em; font-weight: bold;">0</div>
                                            <div style="font-size: 0.9em; opacity: 0.95;">âŒ BilmediÄŸim</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Level Statistics -->
                                <div id="episodeLevelStatsFlashcard" style="display: none; margin-top: 20px; padding-top: 20px; border-top: 2px solid #e5e7eb;">
                                    <h4 style="margin: 0 0 15px; color: #374151; font-size: 1.1em;">ğŸ“Š Seviye DaÄŸÄ±lÄ±mÄ±</h4>
                                    <div id="levelStatsContainerFlashcard" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px;">
                                        <!-- Level stats will be inserted here -->
                                    </div>
                                </div>
                            </div>

                            <!-- Flashcards Section -->
                            <div id="flashcardsSectionFlashcard" style="display: none;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                    <h3 style="margin: 0;">ğŸ§  Flash Kartlar</h3>
                                    <div style="display: flex; gap: 10px;">
                                        <button id="shuffleFlashcardsBtnFlashcard" class="btn btn-secondary">ğŸ”€ KarÄ±ÅŸtÄ±r</button>
                                        <button id="startFlashcardsBtnFlashcard" class="btn btn-success">â–¶ï¸ BaÅŸlat</button>
                                    </div>
                                </div>
                                
                                <!-- Flashcard Display - 3D Flip Card -->
                                <div id="flashcardContainerFlashcard" style="perspective: 1000px; margin-bottom: 20px;">
                                    <div id="flashcardFlashcard" style="width: 100%; height: 280px; position: relative; cursor: pointer; transition: transform 0.6s; transform-style: preserve-3d;">
                                        <!-- Front Side - English Word -->
                                        <div id="flashcardFrontFlashcard" style="position: absolute; width: 100%; height: 100%; backface-visibility: hidden; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 16px; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);">
                                            <!-- Level Badge -->
                                            <div id="flashcardLevelBadgeFlashcard" style="position: absolute; top: 15px; right: 15px; background: rgba(255, 255, 255, 0.3); padding: 6px 14px; border-radius: 20px; font-size: 0.75em; font-weight: 700; backdrop-filter: blur(10px); display: none; z-index: 10; border: 1px solid rgba(255, 255, 255, 0.3); box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);"></div>
                                            
                                            <div id="flashcardWordFlashcard" style="font-size: 2.5em; font-weight: bold; margin-bottom: 10px; text-align: center; padding: 0 20px;">Kelime</div>
                                            <div id="flashcardPronunciationFlashcard" style="font-size: 1em; opacity: 0.9;"></div>
                                            <div id="flashcardFrequencyFlashcard" style="font-size: 0.85em; opacity: 0.7; margin-top: 15px;"></div>
                                            <p style="font-size: 0.8em; opacity: 0.7; margin-top: 20px;">ğŸ”„ TÃ¼rkÃ§e anlamÄ± iÃ§in tÄ±klayÄ±n</p>
                                        </div>
                                        
                                        <!-- Back Side - Turkish Definition -->
                                        <div id="flashcardBackFlashcard" style="position: absolute; width: 100%; height: 100%; backface-visibility: hidden; transform: rotateY(180deg); background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 16px; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; box-shadow: 0 10px 30px rgba(16, 185, 129, 0.3);">
                                            <div style="font-size: 0.9em; opacity: 0.8; margin-bottom: 10px;">ğŸ‡¹ğŸ‡· TÃ¼rkÃ§e AnlamÄ±</div>
                                            <div id="flashcardDefinitionFlashcard" style="font-size: 2em; font-weight: bold; text-align: center; padding: 0 30px; line-height: 1.4;"></div>
                                            <p style="font-size: 0.8em; opacity: 0.7; margin-top: 25px;">ğŸ”„ Ä°ngilizce kelime iÃ§in tÄ±klayÄ±n</p>
                                        </div>
                                    </div>
                                </div>

                                <!-- Flashcard Controls -->
                                <div style="display: flex; justify-content: center; gap: 15px; margin-top: 20px;">
                                    <button id="prevFlashcardBtnFlashcard" class="btn btn-secondary" disabled>â—€ Ã–nceki</button>
                                    <span id="flashcardCounterFlashcard" style="display: flex; align-items: center; font-size: 1.1em; color: #666;">1 / 10</span>
                                    <button id="nextFlashcardBtnFlashcard" class="btn btn-secondary" disabled>Sonraki â–¶</button>
                                </div>

                                <!-- Mark as Known -->
                                <div style="display: flex; justify-content: center; gap: 15px; margin-top: 20px;">
                                    <button id="markUnknownBtnFlashcard" class="btn btn-danger" disabled>âŒ Bilmiyorum</button>
                                    <button id="markKnownBtnFlashcard" class="btn btn-success" disabled>âœ… Biliyorum</button>
                                </div>
                            </div>

                            <div id="noFlashcardsMessageFlashcard" style="display: none; text-align: center; padding: 40px; color: #666;">
                                <p style="font-size: 1.2em;">ğŸ‰ Tebrikler!</p>
                                <p>TÃ¼m kelimeleri Ã¶ÄŸrendiniz!</p>
                            </div>
                        </div>
                    </div>

                    <!-- Video Player Section -->
                    <div class="watch-container" style="display: none;" id="watchContainer">
                        <div class="video-section">
                            <div id="videoPlayer" class="video-player">
                                <video id="videoElement" width="100%" height="100%" controls>
                                    <source id="videoSource" type="video/mp4">
                                </video>
                                <div id="screenShareArea" style="display: none; background: #000; color: #fff; text-align: center; padding: 20px;">
                                    Ekran PaylaÅŸÄ±lan KullanÄ±cÄ±
                                </div>
                            </div>
                            <div class="room-info">
                                <h3 id="currentRoomName">Oda AdÄ±</h3>
                                <p id="currentVideoTitle">Video: SeÃ§ilmemiÅŸ</p>
                            </div>
                        </div>

                        <div class="sidebar">
                            <div class="members-section">
                                <h3>KatÄ±lÄ±mcÄ±lar</h3>
                                <div id="membersList" class="members-list">
                                    <p>Ãœyeler yÃ¼kleniyor...</p>
                                </div>
                            </div>

                            <div class="controls-section">
                                <button id="screenShareBtn" class="btn btn-secondary">
                                    ğŸ“º Ekran PaylaÅŸ
                                </button>
                                <button id="shareRoomBtn" class="btn btn-secondary">
                                    ğŸ”— OdayÄ± PaylaÅŸ
                                </button>
                                <button id="leaveRoomBtn" class="btn btn-danger">
                                    ğŸšª Odadan AyrÄ±l
                                </button>
                            </div>

                            <div class="chat-section">
                                <h3>Sohbet</h3>
                                <div id="chatMessages" class="chat-messages">
                                    <p>Sohbet yÃ¼kleniyor...</p>
                                </div>
                                <div class="chat-input-group">
                                    <input type="text" id="chatInput" placeholder="MesajÄ±nÄ±zÄ± yazÄ±n...">
                                    <button id="sendChatBtn" class="btn btn-primary">GÃ¶nder</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card" style="display: none;" id="noRoomSelected">
                        <p>LÃ¼tfen Ã¶nce bir oda seÃ§in veya oluÅŸturun.</p>
                    </div>


                    <div class="card">
                        <h2>ğŸ“Š AltyazÄ± VeritabanÄ± Ä°statistikleri</h2>
                        <p style="color: #666; font-size: 0.9em; margin-bottom: 15px;">OluÅŸturulan altyazÄ± veritabanlarÄ±nÄ±n kelime istatistikleri</p>

                        <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; align-items: center;">
                            <select id="subtitleDbSeason" style="padding: 8px; border-radius: 4px; border: 1px solid #ddd; min-width: 200px;">
                                <option value="">TÃ¼m KlasÃ¶rler</option>
                            </select>
                            <button id="loadSubtitleDbStatsBtn" class="btn btn-primary">ğŸ“Š Ä°statistikleri Getir</button>
                            <button id="refreshFoldersBtn" class="btn btn-secondary" title="KlasÃ¶rleri Yenile">ğŸ”„</button>
                            <span id="subtitleDbStatsStatus" style="display: none; color: #666;">
                                <span class="spinner"></span> YÃ¼kleniyor...
                            </span>
                        </div>

                        <!-- Summary Stats -->
                        <div id="subtitleDbStatsSummary" style="display: none; margin-bottom: 20px; padding: 15px; background: #f0fdf4; border-radius: 8px; border: 1px solid #86efac;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; text-align: center;">
                                <div>
                                    <div style="font-size: 1.5em; font-weight: bold; color: #15803d;" id="subtitleDbCount">0</div>
                                    <div style="font-size: 0.8em; color: #6b7280;">VeritabanÄ±</div>
                                </div>
                                <div>
                                    <div style="font-size: 1.5em; font-weight: bold; color: #7c3aed;" id="subtitleDbFolders">0</div>
                                    <div style="font-size: 0.8em; color: #6b7280;">KlasÃ¶r</div>
                                </div>
                                <div>
                                    <div style="font-size: 1.5em; font-weight: bold; color: #7c3aed;" id="subtitleDbUniqueWords">0</div>
                                    <div style="font-size: 0.8em; color: #6b7280;">Benzersiz Kelime</div>
                                </div>
                                <div>
                                    <div style="font-size: 1.5em; font-weight: bold; color: #0369a1;" id="subtitleDbTotalWords">0</div>
                                    <div style="font-size: 0.8em; color: #6b7280;">Toplam Kelime</div>
                                </div>
                            </div>
                        </div>

                        <!-- Folders List -->
                        <div id="subtitleDbFoldersList" style="display: none; margin-bottom: 20px;">
                            <h3 style="margin-bottom: 10px; font-size: 1.1em; color: #374151;">ğŸ“ KlasÃ¶rler</h3>
                            <div id="foldersContainer" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px;"></div>
                        </div>

                        <!-- Database List -->
                        <div id="subtitleDbList" style="display: none; max-height: 400px; overflow-y: auto;">
                            <h3 style="margin-bottom: 10px; font-size: 1.1em; color: #374151;">ğŸ’¾ VeritabanlarÄ±</h3>
                            <table style="width: 100%; border-collapse: collapse; font-size: 0.85em;">
                                <thead style="background: #f3f4f6;">
                                    <tr>
                                        <th style="padding: 10px; text-align: left; border-bottom: 2px solid #e5e7eb;">KlasÃ¶r</th>
                                        <th style="padding: 10px; text-align: left; border-bottom: 2px solid #e5e7eb;">VeritabanÄ±</th>
                                        <th style="padding: 10px; text-align: right; border-bottom: 2px solid #e5e7eb;">Benzersiz</th>
                                        <th style="padding: 10px; text-align: right; border-bottom: 2px solid #e5e7eb;">Toplam</th>
                                        <th style="padding: 10px; text-align: center; border-bottom: 2px solid #e5e7eb;">Ä°ÅŸlem</th>
                                    </tr>
                                </thead>
                                <tbody id="subtitleDbBody"></tbody>
                            </table>
                        </div>

                        <div id="subtitleDbStatsError" style="display: none; margin-top: 15px; padding: 15px; background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; color: #dc2626;">
                        </div>
                    </div>
                </div>

                <div id="profileTab" class="tab-content" style="display: none;">
                    <div class="card">
                        <h2>Profil</h2>
                        <p id="userInfo">YÃ¼kleniyor...</p>
                        <div id="statsContent">
                            <p>Ä°statistikler yÃ¼kleniyor...</p>
                        </div>
                    </div>

                    <div class="card">
                        <h2>ğŸ“Š Kelime HaritasÄ±</h2>
                        <p>Ã–ÄŸrenme ilerlemenizi gÃ¶rselleÅŸtirilmiÅŸ olarak takip edin</p>
                <div id="wordMapContainer" style="margin-top: 20px;">
                            <div id="wordStats" class="word-stats-grid">
                                <!-- Ä°statistikler buraya gelecek -->
                            </div>
                            
                            <!-- Flashcard Study Button -->
                            <div style="margin: 25px 0; text-align: center;">
                                <button onclick="openFlashcardModal()" class="btn btn-primary" style="padding: 20px 40px; font-size: 1.2em; border-radius: 12px; box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);">
                                    ğŸ§  Kartla Ã‡alÄ±ÅŸ
                                </button>
                                <p style="margin-top: 10px; color: #6b7280; font-size: 0.9em;">TÃ¼m kelimelere, seviyelere veya zorlandÄ±ÄŸÄ±nÄ±z kelimelere Ã§alÄ±ÅŸÄ±n</p>
                            </div>
                            
                            <div id="wordCategoryMap" class="word-category-map" style="margin-top: 30px;">
                                <!-- Kelime kategorileri haritasÄ± buraya gelecek -->
                            </div>
                        </div>
                    </div>
                        
                    <div class="card">
                        <h3>ğŸ’¾ Veri YÃ¶netimi</h3>
                        <p style="color: #666; font-size: 0.9em; margin-bottom: 15px;">Verilerinizi kaybetmemek iÃ§in dÃ¼zenli yedek alÄ±n.</p>
                        <button id="backupBtn" class="btn btn-primary" style="margin-right: 10px;">â¬‡ï¸ YedeÄŸi Ä°ndir</button>
                        <button id="restoreBtn" class="btn btn-secondary" onclick="document.getElementById('restoreFile').click()">â¬†ï¸ YedeÄŸi Geri YÃ¼kle</button>
                        <input type="file" id="restoreFile" accept=".db" style="display: none;">
                    </div>

                    <div class="card">
                        <button id="logoutBtn" class="btn btn-danger">Ã‡Ä±kÄ±ÅŸ Yap</button>
                    </div>
                </div>
            </section>
        </main>

        <!-- Add Series Modal -->
        <div id="addSeriesModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; justify-content: center; align-items: center;">
            <div class="modal-content" style="background: white; padding: 30px; border-radius: 16px; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto; position: relative;">
                <button onclick="closeAddSeriesModal()" style="position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 1.5em; cursor: pointer; color: #666;">&times;</button>
                
                <h2 style="margin-bottom: 20px; color: #374151;">ğŸ¬ Yeni Dizi/Film Ekle</h2>
                <p style="color: #666; margin-bottom: 20px; font-size: 0.9em;">YouTube veya desteklenen video sitelerinden dizi/film ekleyin. Video indirilerek kelime analizi yapÄ±lacak ve sisteme eklenecektir.</p>
                
                <div class="form-group" style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Dizi/Film AdÄ± *</label>
                    <input type="text" id="newSeriesName" placeholder="Ã–rn: Game of Thrones, Breaking Bad..." style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1em; box-sizing: border-box;">
                </div>
                
                <div class="form-group" style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Video URL *</label>
                    <input type="text" id="newSeriesUrl" placeholder="https://www.youtube.com/watch?v=..." style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1em; box-sizing: border-box;">
                    <p style="color: #9ca3af; font-size: 0.8em; margin-top: 5px;">YouTube, Vimeo veya diÄŸer video siteleri desteklenir</p>
                </div>
                
                <div class="form-group" style="margin-bottom: 25px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">Simge (Emoji)</label>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button type="button" class="emoji-btn" data-emoji="ğŸ¬" style="padding: 10px 15px; border: 2px solid #e5e7eb; border-radius: 8px; background: white; cursor: pointer; font-size: 1.2em;" onclick="selectEmoji('ğŸ¬')">ğŸ¬</button>
                        <button type="button" class="emoji-btn" data-emoji="ğŸ“º" style="padding: 10px 15px; border: 2px solid #e5e7eb; border-radius: 8px; background: white; cursor: pointer; font-size: 1.2em;" onclick="selectEmoji('ğŸ“º')">ğŸ“º</button>
                        <button type="button" class="emoji-btn" data-emoji="ğŸ¥" style="padding: 10px 15px; border: 2px solid #e5e7eb; border-radius: 8px; background: white; cursor: pointer; font-size: 1.2em;" onclick="selectEmoji('ğŸ¥')">ğŸ¥</button>
                        <button type="button" class="emoji-btn" data-emoji="ğŸ­" style="padding: 10px 15px; border: 2px solid #e5e7eb; border-radius: 8px; background: white; cursor: pointer; font-size: 1.2em;" onclick="selectEmoji('ğŸ­')">ğŸ­</button>
                        <button type="button" class="emoji-btn" data-emoji="ğŸª" style="padding: 10px 15px; border: 2px solid #e5e7eb; border-radius: 8px; background: white; cursor: pointer; font-size: 1.2em;" onclick="selectEmoji('ğŸª')">ğŸª</button>
                        <button type="button" class="emoji-btn" data-emoji="ğŸŒŸ" style="padding: 10px 15px; border: 2px solid #e5e7eb; border-radius: 8px; background: white; cursor: pointer; font-size: 1.2em;" onclick="selectEmoji('ğŸŒŸ')">ğŸŒŸ</button>
                        <button type="button" class="emoji-btn" data-emoji="ğŸ‘»" style="padding: 10px 15px; border: 2px solid #e5e7eb; border-radius: 8px; background: white; cursor: pointer; font-size: 1.2em;" onclick="selectEmoji('ğŸ‘»')">ğŸ‘»</button>
                        <button type="button" class="emoji-btn" data-emoji="ğŸš€" style="padding: 10px 15px; border: 2px solid #e5e7eb; border-radius: 8px; background: white; cursor: pointer; font-size: 1.2em;" onclick="selectEmoji('ğŸš€')">ğŸš€</button>
                    </div>
                    <input type="hidden" id="selectedEmoji" value="ğŸ¬">
                </div>
                
                <div id="addSeriesStatus" style="display: none; margin-bottom: 20px; padding: 15px; background: #f3f4f6; border-radius: 8px; text-align: center;">
                    <div class="spinner" style="margin: 0 auto 10px;"></div>
                    <p id="addSeriesStatusText" style="margin: 0; color: #6b7280;">Video indiriliyor ve iÅŸleniyor...</p>
                </div>
                
                <div id="addSeriesError" style="display: none; margin-bottom: 20px; padding: 15px; background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; color: #dc2626;"></div>
                
                <div id="addSeriesSuccess" style="display: none; margin-bottom: 20px; padding: 15px; background: #f0fdf4; border: 1px solid #86efac; border-radius: 8px; color: #15803d;"></div>
                
                <div style="display: flex; gap: 15px;">
                    <button onclick="closeAddSeriesModal()" class="btn btn-secondary" style="flex: 1; padding: 12px;">Ä°ptal</button>
                    <button onclick="addNewSeries()" id="addSeriesBtn" class="btn btn-primary" style="flex: 2; padding: 12px; background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); border: none;">
                        â• Ekle ve Ä°ÅŸle
                    </button>
                </div>
            </div>
        </div>

        <footer>
            <p>&copy; 2026 Watch Together | Film Ä°zle Beraber</p>
        </footer>
    </div>

    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script>
        // Make Google Client ID available to JavaScript
        window.GOOGLE_CLIENT_ID = "{{ google_client_id }}";
    </script>
    <script src="{{ url_for('static', filename='js/app.js') }}?v=4"></script>
    <script>
        // Ä°statistikleri Getir Butonu Ä°ÅŸlevselliÄŸi
        document.addEventListener('DOMContentLoaded', () => {
            const loadStatsBtn = document.getElementById('loadSubtitleDbStatsBtn');
            const refreshFoldersBtn = document.getElementById('refreshFoldersBtn');
            const seasonSelect = document.getElementById('subtitleDbSeason');
            
            // KlasÃ¶rleri yÃ¼kle
            async function loadFolders() {
                try {
                    const response = await fetch('/api/subtitles/stats?path=');
                    const data = await response.json();
                    
                    if (data.success && data.folders) {
                        // Dropdown'u gÃ¼ncelle
                        seasonSelect.innerHTML = '<option value="">TÃ¼m KlasÃ¶rler</option>';
                        data.folders.forEach(folder => {
                            const option = document.createElement('option');
                            option.value = folder.path;
                            option.textContent = `${folder.name} (${folder.db_count} DB)`;
                            seasonSelect.appendChild(option);
                        });
                    }
                } catch (error) {
                    console.error('Error loading folders:', error);
                }
            }
            
            // Ä°statistikleri yÃ¼kle
            async function loadStats() {
                const statusSpan = document.getElementById('subtitleDbStatsStatus');
                const summaryDiv = document.getElementById('subtitleDbStatsSummary');
                const foldersListDiv = document.getElementById('subtitleDbFoldersList');
                const listDiv = document.getElementById('subtitleDbList');
                const tbody = document.getElementById('subtitleDbBody');
                const foldersContainer = document.getElementById('foldersContainer');
                const errorDiv = document.getElementById('subtitleDbStatsError');
                
                // UI SÄ±fÄ±rla
                statusSpan.style.display = 'inline';
                summaryDiv.style.display = 'none';
                foldersListDiv.style.display = 'none';
                listDiv.style.display = 'none';
                errorDiv.style.display = 'none';
                tbody.innerHTML = '';
                foldersContainer.innerHTML = '';
                
                const path = seasonSelect.value;
                
                try {
                    const response = await fetch(`/api/subtitles/stats?path=${encodeURIComponent(path)}`);
                    const data = await response.json();
                    
                    if (data.success) {
                        // Ã–zeti GÃ¼ncelle
                        document.getElementById('subtitleDbCount').textContent = data.summary.total_databases;
                        document.getElementById('subtitleDbFolders').textContent = data.summary.total_folders || 0;
                        document.getElementById('subtitleDbUniqueWords').textContent = data.summary.total_unique_words.toLocaleString('tr-TR');
                        document.getElementById('subtitleDbTotalWords').textContent = data.summary.total_words.toLocaleString('tr-TR');
                        
                        summaryDiv.style.display = 'block';
                        
                        // KlasÃ¶rleri gÃ¶ster (sadece tÃ¼m klasÃ¶rler gÃ¶rÃ¼nÃ¼mÃ¼nde)
                        if (!path && data.folders && data.folders.length > 0) {
                            data.folders.forEach(folder => {
                                const folderCard = document.createElement('div');
                                folderCard.style.cssText = 'padding: 15px; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; cursor: pointer; transition: all 0.2s;';
                                folderCard.style.cursor = 'pointer';
                                folderCard.onmouseover = () => folderCard.style.background = '#f3f4f6';
                                folderCard.onmouseout = () => folderCard.style.background = '#f9fafb';
                                folderCard.onclick = () => {
                                    seasonSelect.value = folder.path;
                                    loadStats();
                                };
                                
                                folderCard.innerHTML = `
                                    <div style="font-weight: 600; color: #374151; margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
                                        <span>ğŸ“</span>
                                        <span>${folder.name || 'Root'}</span>
                                    </div>
                                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 10px; font-size: 0.85em;">
                                        <div style="text-align: center;">
                                            <div style="font-weight: bold; color: #15803d;">${folder.db_count}</div>
                                            <div style="color: #6b7280; font-size: 0.8em;">DB</div>
                                        </div>
                                        <div style="text-align: center;">
                                            <div style="font-weight: bold; color: #7c3aed;">${folder.unique_words.toLocaleString('tr-TR')}</div>
                                            <div style="color: #6b7280; font-size: 0.8em;">Benzersiz</div>
                                        </div>
                                        <div style="text-align: center;">
                                            <div style="font-weight: bold; color: #0369a1;">${folder.total_words.toLocaleString('tr-TR')}</div>
                                            <div style="color: #6b7280; font-size: 0.8em;">Toplam</div>
                                        </div>
                                    </div>
                                `;
                                foldersContainer.appendChild(folderCard);
                            });
                            foldersListDiv.style.display = 'block';
                        }
                        
                        // VeritabanlarÄ±nÄ± gÃ¶ster
                        if (data.databases && data.databases.length > 0) {
                            data.databases.forEach(db => {
                                const row = document.createElement('tr');
                                const folderName = db.folder ? db.folder.split('/').pop() || db.folder : 'Root';
                                row.innerHTML = `
                                    <td style="padding: 10px; border-bottom: 1px solid #eee; color: #6b7280; font-size: 0.85em;">${folderName}</td>
                                    <td style="padding: 10px; border-bottom: 1px solid #eee;">${db.name}</td>
                                    <td style="padding: 10px; text-align: right; border-bottom: 1px solid #eee;">${db.unique_words.toLocaleString('tr-TR')}</td>
                                    <td style="padding: 10px; text-align: right; border-bottom: 1px solid #eee;">${db.total_words.toLocaleString('tr-TR')}</td>
                                    <td style="padding: 10px; text-align: center; border-bottom: 1px solid #eee;">
                                        <button class="btn btn-sm btn-secondary" onclick="alert('Detay Ã¶zelliÄŸi yakÄ±nda eklenecek: ${db.name}')">Detay</button>
                                    </td>
                                `;
                                tbody.appendChild(row);
                            });
                            listDiv.style.display = 'block';
                        } else {
                            errorDiv.textContent = 'Bu klasÃ¶rde veritabanÄ± bulunamadÄ±.';
                            errorDiv.style.display = 'block';
                        }
                    } else {
                        errorDiv.textContent = data.error || 'Veriler alÄ±nÄ±rken bir hata oluÅŸtu.';
                        errorDiv.style.display = 'block';
                    }
                } catch (error) {
                    console.error('Error fetching stats:', error);
                    errorDiv.textContent = 'Sunucu hatasÄ±: ' + error.message;
                    errorDiv.style.display = 'block';
                } finally {
                    statusSpan.style.display = 'none';
                }
            }
            
            // Event listeners
            if (loadStatsBtn) {
                loadStatsBtn.addEventListener('click', loadStats);
            }
            
            if (refreshFoldersBtn) {
                refreshFoldersBtn.addEventListener('click', () => {
                    loadFolders().then(() => loadStats());
                });
            }
            
            if (seasonSelect) {
                seasonSelect.addEventListener('change', loadStats);
            }
            
            // Sayfa yÃ¼klendiÄŸinde klasÃ¶rleri ve istatistikleri yÃ¼kle
            loadFolders().then(() => loadStats());
        });

        // Profil Kelime HaritasÄ± ve Ä°statistikleri
        async function loadProfileWordMap() {
            let userId = localStorage.getItem('user_id');
            if (!userId && window.currentUser && window.currentUser.user_id) {
                userId = String(window.currentUser.user_id);
            }
            
            const mapContainer = document.getElementById('wordCategoryMap');
            const statsContainer = document.getElementById('wordStats');
            
            if (!mapContainer) {
                console.warn('wordCategoryMap container not found');
                return;
            }
            
            // Her zaman yÃ¼kleniyor gÃ¶ster
            mapContainer.innerHTML = '<div style="text-align:center; padding:20px;"><div class="spinner"></div><p>Veriler yÃ¼kleniyor...</p></div>';
            
            if (!userId) {
                mapContainer.innerHTML = '<div style="text-align:center; padding:20px; color:#666;"><p>KullanÄ±cÄ± ID bulunamadÄ±. LÃ¼tfen giriÅŸ yapÄ±n.</p></div>';
                return;
            }

            try {
                // Ã–nce profil API'sini dene (genel kelime haritasÄ±)
                const response = await fetch(`/api/profile/word-map?user_id=${userId}`);
                const data = await response.json();

                if (data.success) {
                    if (data.summary) {
                        renderWordStats(data.summary);
                    }
                    if (data.levels && data.levels.length > 0) {
                        renderLevels(data.levels, data.progress);
                    } else {
                        mapContainer.innerHTML = '<div style="text-align:center; padding:20px; color:#666;"><p>HenÃ¼z kelime seviyesi oluÅŸturulmamÄ±ÅŸ.</p><p>LÃ¼tfen "Film Ä°zle" sekmesinden bir dizi seÃ§ip "Kelime HaritasÄ± OluÅŸtur" butonuna tÄ±klayarak kelime havuzunu oluÅŸturun.</p></div>';
                    }
                } else {
                    mapContainer.innerHTML = '<p style="color:red; text-align:center;">Veriler yÃ¼klenirken hata oluÅŸtu: ' + (data.error || 'Bilinmeyen hata') + '</p>';
                }
            } catch (error) {
                console.error('Error loading word map:', error);
                mapContainer.innerHTML = '<p style="color:red; text-align:center;">Veriler yÃ¼klenirken hata oluÅŸtu: ' + error.message + '</p>';
            }
        }
        // Make loadProfileWordMap globally accessible
        window.loadProfileWordMap = loadProfileWordMap;

        function renderWordStats(summary) {
            const container = document.getElementById('wordStats');
            if (!container) return;

            const total = summary.total_words || 0;
            const known = summary.known_words || 0;
            const unknown = total - known;
            const percentage = total > 0 ? Math.round((known / total) * 100) : 0;

            container.innerHTML = `
                <div class="stat-box">
                    <div class="stat-box-number">${total.toLocaleString()}</div>
                    <div class="stat-box-label">Toplam Kelime</div>
                </div>
                <div class="stat-box known">
                    <div class="stat-box-number">${known.toLocaleString()}</div>
                    <div class="stat-box-label">Bilinen</div>
                    <div class="stat-box-percent">%${percentage}</div>
                </div>
                <div class="stat-box unknown">
                    <div class="stat-box-number">${unknown.toLocaleString()}</div>
                    <div class="stat-box-label">Ã–ÄŸrenilecek</div>
                </div>
            `;
        }

        function renderLevels(levels, progress) {
            const container = document.getElementById('wordCategoryMap');
            if (!container) return;

            let html = '<div class="levels-grid">';
            
            levels.forEach(level => {
                const known = progress[level.id] || 0;
                const total = level.word_count;
                const percent = total > 0 ? Math.round((known / total) * 100) : 0;
                
                let statusClass = 'low';
                if (percent >= 80) statusClass = 'high';
                else if (percent >= 40) statusClass = 'medium';

                // Determine color variable for inline style
                const colorVar = statusClass === 'high' ? 'var(--secondary)' : (statusClass === 'medium' ? 'var(--warning)' : 'var(--danger)');

                html += `
                    <div class="level-card">
                        <div class="level-card-header">
                            <div>
                                <h3 class="level-card-title">${level.package_name}</h3>
                                <div class="level-card-freq">Frekans: ${level.max_frequency} - ${level.min_frequency}</div>
                            </div>
                            <div class="level-card-percent ${statusClass}">%${percent}</div>
                        </div>
                        <div class="level-card-progress">
                            <span>${known} / ${total} kelime</span>
                        </div>
                        <div class="level-card-bar">
                            <div class="level-card-fill" style="width: ${percent}%; background-color: ${colorVar}"></div>
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            container.innerHTML = html;
        }

        // Tab deÄŸiÅŸimi dinleyicisi â€“ profil tÄ±klanÄ±nca Ã¶nce sekmeyi aÃ§, sonra kelime haritasÄ±nÄ± yÃ¼kle
        // Note: loadProfileWordMap is now called automatically by switchTab function
        document.addEventListener('DOMContentLoaded', () => {
            
            // ===== SERÄ°S SEÃ‡Ä°MÄ° VE EPÄ°ZOD FLASHCARD Ä°ÅLEVLERÄ° =====

            // Dizi posterlerine tÄ±klama (sadece poster alanÄ±na, butona deÄŸil)
            const seriesCards = document.querySelectorAll('.series-card');
            
            seriesCards.forEach(card => {
                const button = card.querySelector('button');
                const checkbox = card.querySelector('.series-checkbox');
                
                card.addEventListener('click', (e) => {
                    // EÄŸer butona, checkbox'a veya label'a tÄ±klandÄ±ysa, selectSeries Ã§aÄŸÄ±rma
                    if (e.target === button || button?.contains(e.target) || 
                        e.target === checkbox || e.target.closest('label') ||
                        e.target.type === 'checkbox') {
                        return;
                    }
                    const series = card.dataset.series;
                    if (series) {
                        selectSeries(series);
                    }
                });
                
                // Hover efekti
                card.addEventListener('mouseenter', () => {
                    card.style.transform = 'scale(1.05)';
                });
                card.addEventListener('mouseleave', () => {
                    card.style.transform = 'scale(1)';
                });
            });
        });

        // ===== BÃ–LÃœM FLASHCARD Ã‡ALIÅMA ALANI Ä°ÅLEVLERÄ° =====
        
        // Yeni flashcard alanÄ± iÃ§in dizi seÃ§imi
        document.querySelectorAll('.series-card-flashcard').forEach(card => {
            card.addEventListener('click', () => {
                const series = card.dataset.series;
                selectSeriesForFlashcard(series);
            });
            
            // Hover efekti
            card.addEventListener('mouseenter', () => {
                card.style.transform = 'scale(1.05)';
            });
            card.addEventListener('mouseleave', () => {
                card.style.transform = 'scale(1)';
            });
        });

        function selectSeriesForFlashcard(series) {
            const episodeSelectionCard = document.getElementById('episodeSelectionCardFlashcard');
            const seriesTitle = document.getElementById('selectedSeriesTitleFlashcard');
            const seasonSelect = document.getElementById('seriesSeasonSelectFlashcard');
            
            episodeSelectionCard.style.display = 'block';
            
            // BaÅŸlÄ±k gÃ¼ncelle
            if (series === 'friends') {
                seriesTitle.textContent = 'ğŸ‘« Friends - BÃ¶lÃ¼m SeÃ§imi';
            } else {
                seriesTitle.textContent = 'ğŸ§  Big Bang Theory - BÃ¶lÃ¼m SeÃ§imi';
            }

            // Ã–nce statik sezon listesini gÃ¶ster
            let seasons = [];
            if (series === 'friends') {
                seasons = [
                    { value: '1', label: 'Sezon 1 (24 bÃ¶lÃ¼m)' },
                    { value: '2', label: 'Sezon 2 (24 bÃ¶lÃ¼m)' },
                    { value: '3', label: 'Sezon 3 (25 bÃ¶lÃ¼m)' },
                    { value: '4', label: 'Sezon 4 (24 bÃ¶lÃ¼m)' },
                    { value: '5', label: 'Sezon 5 (24 bÃ¶lÃ¼m)' },
                    { value: '6', label: 'Sezon 6 (25 bÃ¶lÃ¼m)' },
                    { value: '7', label: 'Sezon 7 (24 bÃ¶lÃ¼m)' },
                    { value: '8', label: 'Sezon 8 (24 bÃ¶lÃ¼m)' },
                    { value: '9', label: 'Sezon 9 (24 bÃ¶lÃ¼m)' },
                    { value: '10', label: 'Sezon 10 (18 bÃ¶lÃ¼m)' }
                ];
            } else {
                seasons = [
                    { value: '1', label: 'Sezon 1 (17 bÃ¶lÃ¼m)' },
                    { value: '2', label: 'Sezon 2 (23 bÃ¶lÃ¼m)' },
                    { value: '3', label: 'Sezon 3 (23 bÃ¶lÃ¼m)' },
                    { value: '4', label: 'Sezon 4 (24 bÃ¶lÃ¼m)' },
                    { value: '5', label: 'Sezon 5 (24 bÃ¶lÃ¼m)' },
                    { value: '6', label: 'Sezon 6 (24 bÃ¶lÃ¼m)' },
                    { value: '7', label: 'Sezon 7 (24 bÃ¶lÃ¼m)' },
                    { value: '8', label: 'Sezon 8 (24 bÃ¶lÃ¼m)' },
                    { value: '9', label: 'Sezon 9 (24 bÃ¶lÃ¼m)' },
                    { value: '10', label: 'Sezon 10 (24 bÃ¶lÃ¼m)' },
                    { value: '11', label: 'Sezon 11 (24 bÃ¶lÃ¼m)' },
                    { value: '12', label: 'Sezon 12 (24 bÃ¶lÃ¼m)' }
                ];
            }
            
            // Statik sezon listesini hemen doldur
            seasonSelect.innerHTML = '<option value="">Sezon SeÃ§in</option>';
            seasons.forEach(s => {
                const option = document.createElement('option');
                option.value = s.value;
                option.textContent = s.label;
                seasonSelect.appendChild(option);
            });
            
            // BÃ¶lÃ¼m dropdown'Ä±nÄ± sÄ±fÄ±rla
            const episodeSelect = document.getElementById('seriesEpisodeSelectFlashcard');
            episodeSelect.innerHTML = '<option value="">Ã–nce Sezon SeÃ§in</option>';
            episodeSelect.disabled = true;
            
            // Flashcard butonunu devre dÄ±ÅŸÄ± bÄ±rak
            document.getElementById('loadEpisodeFlashcardsBtnFlashcard').disabled = true;
            document.getElementById('loadEpisodeFlashcardsBtnFlashcard').dataset.series = series;
            
            // Transcript butonunu da devre dÄ±ÅŸÄ± bÄ±rak
            const transcriptBtnFlashcard = document.getElementById('openTranscriptStudyBtnFlashcard');
            if (transcriptBtnFlashcard) transcriptBtnFlashcard.disabled = true;
            
            // BÃ¶lÃ¼m bilgisi ve flashcard alanlarÄ±nÄ± gizle
            document.getElementById('episodeInfoFlashcard').style.display = 'none';
            document.getElementById('flashcardsSectionFlashcard').style.display = 'none';
            document.getElementById('noFlashcardsMessageFlashcard').style.display = 'none';
            
            // Scroll to episode selection
            episodeSelectionCard.scrollIntoView({ behavior: 'smooth' });
        }

        // Sezon seÃ§imi deÄŸiÅŸtiÄŸinde (yeni alan iÃ§in)
        document.getElementById('seriesSeasonSelectFlashcard').addEventListener('change', async function() {
            const season = this.value;
            const series = document.getElementById('loadEpisodeFlashcardsBtnFlashcard').dataset.series;
            const episodeSelect = document.getElementById('seriesEpisodeSelectFlashcard');
            
            if (!season) {
                episodeSelect.innerHTML = '<option value="">Ã–nce Sezon SeÃ§in</option>';
                episodeSelect.disabled = true;
                document.getElementById('loadEpisodeFlashcardsBtnFlashcard').disabled = true;
                const transcriptBtnFlashcard = document.getElementById('openTranscriptStudyBtnFlashcard');
                if (transcriptBtnFlashcard) transcriptBtnFlashcard.disabled = true;
                return;
            }
            
            // Statik bÃ¶lÃ¼m sayÄ±larÄ±
            let episodeCount = 24; // default
            if (series === 'friends') {
                const counts = { '1': 24, '2': 24, '3': 25, '4': 24, '5': 24, '6': 25, '7': 24, '8': 24, '9': 24, '10': 18 };
                episodeCount = counts[season] || 24;
            } else {
                const counts = { '1': 17, '2': 23, '3': 23, '4': 24, '5': 24, '6': 24, '7': 24, '8': 24, '9': 24, '10': 24, '11': 24, '12': 24 };
                episodeCount = counts[season] || 24;
            }
            
            // BÃ¶lÃ¼m dropdown'Ä±nÄ± doldur
            episodeSelect.innerHTML = '<option value="">BÃ¶lÃ¼m SeÃ§in</option>';
            for (let ep = 1; ep <= episodeCount; ep++) {
                const option = document.createElement('option');
                option.value = ep;
                option.textContent = `BÃ¶lÃ¼m ${ep}`;
                episodeSelect.appendChild(option);
            }
            episodeSelect.disabled = false;
        });

        // BÃ¶lÃ¼m seÃ§imi deÄŸiÅŸtiÄŸinde (yeni alan iÃ§in)
        document.getElementById('seriesEpisodeSelectFlashcard').addEventListener('change', function() {
            const episode = this.value;
            const loadBtn = document.getElementById('loadEpisodeFlashcardsBtnFlashcard');
            const transcriptBtn = document.getElementById('openTranscriptStudyBtnFlashcard');
            const series = document.getElementById('loadEpisodeFlashcardsBtnFlashcard').dataset.series;
            const season = document.getElementById('seriesSeasonSelectFlashcard').value;
            
            if (episode) {
                loadBtn.disabled = false;
                loadBtn.dataset.series = series;
                loadBtn.dataset.season = season;
                loadBtn.dataset.episode = episode;
                // Transcript butonunu da enable et
                if (transcriptBtn) {
                    transcriptBtn.disabled = false;
                }
            } else {
                loadBtn.disabled = true;
                if (transcriptBtn) {
                    transcriptBtn.disabled = true;
                }
            }
        });

        // Flash KartlarÄ± Getir butonu (yeni alan iÃ§in)
        document.getElementById('loadEpisodeFlashcardsBtnFlashcard').addEventListener('click', async function() {
            const series = this.dataset.series;
            const season = parseInt(this.dataset.season);
            const episode = parseInt(this.dataset.episode);
            const customSeries = this.dataset.customSeries;
            const customEpisode = this.dataset.customEpisode;
            const userId = localStorage.getItem('user_id');

            // Custom series iÃ§in farklÄ± kontrol
            if (customSeries && customEpisode) {
                try {
                    let url = `/api/custom-series/${customSeries}/flashcards?episode=${encodeURIComponent(customEpisode)}`;
                    if (window.currentUser && window.currentUser.user_id) {
                        url += `&user_id=${window.currentUser.user_id}`;
                    }
                    const response = await fetch(url);
                    const data = await response.json();

                    if (data.success) {
                        displayFlashcardsForNewArea(data);
                    } else {
                        alert('Flashcard yÃ¼klenirken hata: ' + (data.error || 'Bu bÃ¶lÃ¼m iÃ§in kelime bulunamadÄ±'));
                    }
                } catch (error) {
                    console.error('Error loading custom series flashcards:', error);
                    alert('Flashcard yÃ¼klenirken hata: ' + error.message);
                }
                return;
            }

            // Normal series (Friends, Big Bang) iÃ§in kontrol
            if (!series || !season || !episode) {
                alert('LÃ¼tfen sezon ve bÃ¶lÃ¼m seÃ§in!');
                return;
            }

            try {
                let url = `/api/series/${series}/episodes/${season}/${episode}/flashcards`;
                if (window.currentUser && window.currentUser.user_id) {
                    url += `?user_id=${window.currentUser.user_id}`;
                }
                const response = await fetch(url);
                const data = await response.json();

                if (data.success) {
                    displayFlashcardsForNewArea(data);
                } else {
                    alert('Flashcard yÃ¼klenirken hata: ' + (data.error || 'Bu bÃ¶lÃ¼m iÃ§in kelime bulunamadÄ±'));
                }
            } catch (error) {
                console.error('Error loading flashcards:', error);
                alert('Flashcard yÃ¼klenirken hata: ' + error.message);
            }
        });

        // Yeni alan iÃ§in flashcard gÃ¶rÃ¼ntÃ¼leme fonksiyonu
        function displayFlashcardsForNewArea(data) {
            const episodeInfo = document.getElementById('episodeInfoFlashcard');
            const flashcardsSection = document.getElementById('flashcardsSectionFlashcard');
            const noFlashcardsMessage = document.getElementById('noFlashcardsMessageFlashcard');
            
            // BÃ¶lÃ¼m bilgilerini gÃ¶ster
            const title = data.video ? data.video.title : (data.flashcards.length > 0 ? data.flashcards[0].word : "No words found");
            document.getElementById('episodeTitleFlashcard').textContent = title;
            document.getElementById('episodeWordCountFlashcard').textContent = data.flashcards.length;
            
            // BildiÄŸim ve bilmediÄŸim kelime sayÄ±larÄ±nÄ± gÃ¶ster
            const knownCount = data.known_count !== undefined ? data.known_count : 0;
            const unknownCount = data.unknown_count !== undefined ? data.unknown_count : data.flashcards.length;
            document.getElementById('episodeKnownCountFlashcard').textContent = knownCount;
            document.getElementById('episodeUnknownCountFlashcard').textContent = unknownCount;
            
            // Seviye istatistiklerini gÃ¶ster (tÃ¼m kelimeler iÃ§in)
            const levelStatsContainer = document.getElementById('levelStatsContainerFlashcard');
            const episodeLevelStats = document.getElementById('episodeLevelStatsFlashcard');
            
            const statsToShow = data.level_stats_all || data.level_stats || {};
            
            if (statsToShow && Object.keys(statsToShow).length > 0) {
                levelStatsContainer.innerHTML = '';
                
                const sortedLevels = Object.keys(statsToShow).sort((a, b) => {
                    if (a === 'Seviye DÄ±ÅŸÄ±') return 1;
                    if (b === 'Seviye DÄ±ÅŸÄ±') return -1;
                    return parseInt(a) - parseInt(b);
                });
                
                sortedLevels.forEach(levelKey => {
                    const levelData = statsToShow[levelKey];
                    const levelCard = document.createElement('div');
                    levelCard.style.cssText = 'padding: 12px; background: #fff; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); border-left: 4px solid #667eea;';
                    
                    let borderColor = '#667eea';
                    if (levelData.level_number !== null && levelData.level_number !== undefined) {
                        const levelNum = parseInt(levelData.level_number);
                        if (levelNum <= 3) {
                            borderColor = '#ef4444';
                        } else if (levelNum <= 6) {
                            borderColor = '#f59e0b';
                        } else if (levelNum <= 10) {
                            borderColor = '#3b82f6';
                        } else {
                            borderColor = '#10b981';
                        }
                    } else {
                        borderColor = '#9ca3af';
                    }
                    
                    levelCard.style.borderLeftColor = borderColor;
                    levelCard.innerHTML = `
                        <div style="font-weight: 600; color: #374151; margin-bottom: 5px; font-size: 0.9em;">${levelData.level_name}</div>
                        <div style="font-size: 1.5em; font-weight: bold; color: ${borderColor};">${levelData.word_count}</div>
                        <div style="font-size: 0.75em; color: #6b7280; margin-top: 3px;">kelime</div>
                    `;
                    levelStatsContainer.appendChild(levelCard);
                });
                
                episodeLevelStats.style.display = 'block';
            } else {
                episodeLevelStats.style.display = 'none';
            }
            
            episodeInfo.style.display = 'block';
            
            if (data.flashcards.length === 0) {
                flashcardsSection.style.display = 'none';
                noFlashcardsMessage.style.display = 'block';
                return;
            }
            
            noFlashcardsMessage.style.display = 'none';
            flashcardsSection.style.display = 'block';
            
            // Flashcard state'ini ayarla
            window.currentFlashcardsFlashcard = data.flashcards;
            window.currentFlashcardIndexFlashcard = 0;
            window.flashcardFlippedFlashcard = false;
            
            updateFlashcardDisplayForNewArea();
            updateFlashcardControlsForNewArea();
        }

        // Yeni alan iÃ§in flashcard gÃ¶rÃ¼nÃ¼mÃ¼nÃ¼ gÃ¼ncelle
        function updateFlashcardDisplayForNewArea() {
            if (!window.currentFlashcardsFlashcard || window.currentFlashcardsFlashcard.length === 0) return;
            
            const card = window.currentFlashcardsFlashcard[window.currentFlashcardIndexFlashcard];
            const flashcard = document.getElementById('flashcardFlashcard');
            
            if (!card || !flashcard) return;
            
            document.getElementById('flashcardWordFlashcard').textContent = card.word || 'Kelime';
            document.getElementById('flashcardPronunciationFlashcard').textContent = card.pronunciation || '';
            document.getElementById('flashcardDefinitionFlashcard').textContent = card.definition || '(Ã‡eviri henÃ¼z eklenmemiÅŸ - Kelime HaritasÄ±ndan "Ã‡evir" butonunu kullanÄ±n)';
            document.getElementById('flashcardFrequencyFlashcard').textContent = card.frequency ? `Frekans: ${card.frequency}` : '';
            
            // Seviye bilgisini gÃ¶ster
            const levelBadge = document.getElementById('flashcardLevelBadgeFlashcard');
            if (!levelBadge) return;
            
            if (card.level_number !== null && card.level_number !== undefined && card.level_number !== 'Seviye DÄ±ÅŸÄ±') {
                const levelNum = parseInt(card.level_number);
                if (!isNaN(levelNum) && levelNum > 0) {
                    levelBadge.textContent = `Seviye ${levelNum}`;
                    levelBadge.style.display = 'block';
                    levelBadge.style.visibility = 'visible';
                    levelBadge.style.opacity = '1';
                    
                    if (levelNum <= 3) {
                        levelBadge.style.background = 'rgba(239, 68, 68, 0.6)';
                        levelBadge.style.color = '#fff';
                    } else if (levelNum <= 6) {
                        levelBadge.style.background = 'rgba(245, 158, 11, 0.6)';
                        levelBadge.style.color = '#fff';
                    } else if (levelNum <= 10) {
                        levelBadge.style.background = 'rgba(59, 130, 246, 0.6)';
                        levelBadge.style.color = '#fff';
                    } else {
                        levelBadge.style.background = 'rgba(16, 185, 129, 0.6)';
                        levelBadge.style.color = '#fff';
                    }
                } else {
                    levelBadge.style.display = 'none';
                }
            } else if (card.level_name && card.level_name !== 'Seviye DÄ±ÅŸÄ±' && card.level_name !== undefined) {
                levelBadge.textContent = card.level_name;
                levelBadge.style.display = 'block';
                levelBadge.style.visibility = 'visible';
                levelBadge.style.opacity = '1';
                levelBadge.style.background = 'rgba(255, 255, 255, 0.5)';
                levelBadge.style.color = '#fff';
            } else {
                levelBadge.textContent = 'Seviye DÄ±ÅŸÄ±';
                levelBadge.style.display = 'block';
                levelBadge.style.visibility = 'visible';
                levelBadge.style.opacity = '1';
                levelBadge.style.background = 'rgba(156, 163, 175, 0.5)';
                levelBadge.style.color = '#fff';
            }
            
            flashcard.style.transform = 'rotateY(0deg)';
            window.flashcardFlippedFlashcard = false;
        }

        // Yeni alan iÃ§in flashcard kontrollerini gÃ¼ncelle
        function updateFlashcardControlsForNewArea() {
            const total = window.currentFlashcardsFlashcard ? window.currentFlashcardsFlashcard.length : 0;
            const current = window.currentFlashcardIndexFlashcard;
            
            document.getElementById('flashcardCounterFlashcard').textContent = `${current + 1} / ${total}`;
            
            const prevBtn = document.getElementById('prevFlashcardBtnFlashcard');
            const nextBtn = document.getElementById('nextFlashcardBtnFlashcard');
            const markKnownBtn = document.getElementById('markKnownBtnFlashcard');
            const markUnknownBtn = document.getElementById('markUnknownBtnFlashcard');
            
            prevBtn.disabled = current === 0;
            nextBtn.disabled = current === total - 1;
            markKnownBtn.disabled = total === 0;
            markUnknownBtn.disabled = total === 0;
        }

        // KartÄ± Ã§evir (yeni alan iÃ§in)
        document.getElementById('flashcardFlashcard').addEventListener('click', function() {
            const flashcard = document.getElementById('flashcardFlashcard');
            flashcard.style.transform = window.flashcardFlippedFlashcard ? 'rotateY(0deg)' : 'rotateY(180deg)';
            window.flashcardFlippedFlashcard = !window.flashcardFlippedFlashcard;
        });

        // Ã–nceki/Sonraki kart (yeni alan iÃ§in)
        document.getElementById('prevFlashcardBtnFlashcard').addEventListener('click', () => {
            if (window.currentFlashcardIndexFlashcard > 0) {
                window.currentFlashcardIndexFlashcard--;
                updateFlashcardDisplayForNewArea();
                updateFlashcardControlsForNewArea();
            }
        });

        document.getElementById('nextFlashcardBtnFlashcard').addEventListener('click', () => {
            if (window.currentFlashcardsFlashcard && window.currentFlashcardIndexFlashcard < window.currentFlashcardsFlashcard.length - 1) {
                window.currentFlashcardIndexFlashcard++;
                updateFlashcardDisplayForNewArea();
                updateFlashcardControlsForNewArea();
            }
        });

        // KarÄ±ÅŸtÄ±r (yeni alan iÃ§in)
        document.getElementById('shuffleFlashcardsBtnFlashcard').addEventListener('click', () => {
            if (!window.currentFlashcardsFlashcard) return;
            
            for (let i = window.currentFlashcardsFlashcard.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [window.currentFlashcardsFlashcard[i], window.currentFlashcardsFlashcard[j]] = 
                [window.currentFlashcardsFlashcard[j], window.currentFlashcardsFlashcard[i]];
            }
            
            window.currentFlashcardIndexFlashcard = 0;
            updateFlashcardDisplayForNewArea();
            updateFlashcardControlsForNewArea();
        });

        // BaÅŸlat (yeni alan iÃ§in)
        document.getElementById('startFlashcardsBtnFlashcard').addEventListener('click', () => {
            window.currentFlashcardIndexFlashcard = 0;
            updateFlashcardDisplayForNewArea();
            updateFlashcardControlsForNewArea();
        });

        // Bilmiyorum/Biliyorum butonlarÄ± (yeni alan iÃ§in)
        document.getElementById('markKnownBtnFlashcard').addEventListener('click', async () => {
            await markFlashcardForNewArea(true);
        });

        document.getElementById('markUnknownBtnFlashcard').addEventListener('click', async () => {
            await markFlashcardForNewArea(false);
        });

        async function markFlashcardForNewArea(known) {
            if (!window.currentUser || !window.currentUser.user_id) {
                alert('LÃ¼tfen Ã¶nce giriÅŸ yapÄ±n!');
                return;
            }
            
            if (!window.currentFlashcardsFlashcard || window.currentFlashcardsFlashcard.length === 0) return;
            
            const card = window.currentFlashcardsFlashcard[window.currentFlashcardIndexFlashcard];
            
            try {
                const response = await fetch(`/api/words/${card.id}/mark`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: window.currentUser.user_id, known: known })
                });
                
                const data = await response.json();
                if (data.success) {
                    window.currentFlashcardsFlashcard.splice(window.currentFlashcardIndexFlashcard, 1);
                    
                    if (window.currentFlashcardsFlashcard.length === 0) {
                        document.getElementById('flashcardsSectionFlashcard').style.display = 'none';
                        document.getElementById('noFlashcardsMessageFlashcard').style.display = 'block';
                        document.getElementById('episodeUnknownCountFlashcard').textContent = '0';
                        const knownCount = parseInt(document.getElementById('episodeKnownCountFlashcard').textContent) + 1;
                        document.getElementById('episodeKnownCountFlashcard').textContent = knownCount;
                    } else {
                        if (window.currentFlashcardIndexFlashcard >= window.currentFlashcardsFlashcard.length) {
                            window.currentFlashcardIndexFlashcard = window.currentFlashcardsFlashcard.length - 1;
                        }
                        updateFlashcardDisplayForNewArea();
                        updateFlashcardControlsForNewArea();
                        
                        if (known) {
                            const knownCount = parseInt(document.getElementById('episodeKnownCountFlashcard').textContent) + 1;
                            const unknownCount = parseInt(document.getElementById('episodeUnknownCountFlashcard').textContent) - 1;
                            document.getElementById('episodeKnownCountFlashcard').textContent = knownCount;
                            document.getElementById('episodeUnknownCountFlashcard').textContent = Math.max(0, unknownCount);
                        }
                    }
                }
            } catch (error) {
                console.error('Error marking word:', error);
            }
        }

        // Checkbox deÄŸiÅŸikliklerini dinle
        document.querySelectorAll('.series-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                updateBuildButton();
                updateSelectedSeriesText();
                updateCardBorder(this);
            });
        });
        
        // Sayfa yÃ¼klendiÄŸinde baÅŸlangÄ±Ã§ durumunu ayarla
        updateBuildButton();
        updateSelectedSeriesText();

        // Kart border'Ä±nÄ± gÃ¼ncelle
        function updateCardBorder(checkbox) {
            const card = checkbox.closest('.series-card');
            if (checkbox.checked) {
                card.style.borderColor = '#667eea';
                card.style.boxShadow = '0 4px 15px rgba(102, 126, 234, 0.6)';
            } else {
                card.style.borderColor = 'transparent';
                card.style.boxShadow = '';
            }
        }

        // SeÃ§ili dizileri gÃ¼ncelle
        function updateSelectedSeriesText() {
            const selected = getSelectedSeries();
            const textDiv = document.getElementById('selectedSeriesText');
            
            if (selected.length === 0) {
                textDiv.textContent = 'LÃ¼tfen en az bir dizi seÃ§in';
            } else {
                const seriesNames = selected.map(s => {
                    if (s === 'friends') return 'Friends';
                    if (s === 'bigbang') return 'Big Bang Theory';
                    // Custom series iÃ§in ID'yi daha okunabilir hale getir
                    return s.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
                });
                textDiv.textContent = `SeÃ§ili: ${seriesNames.join(', ')}`;
            }
        }

        // Build butonunu gÃ¼ncelle
        function updateBuildButton() {
            const selected = getSelectedSeries();
            const buildBtn = document.getElementById('buildWordMapBtn');
            buildBtn.disabled = selected.length === 0;
        }

        // SeÃ§ili dizileri al
        function getSelectedSeries() {
            const checkboxes = document.querySelectorAll('.series-checkbox:checked');
            return Array.from(checkboxes).map(cb => cb.dataset.series);
        }

        // BirleÅŸik Kelime HaritasÄ± OluÅŸtur fonksiyonu
        async function buildCombinedWordMap() {
            const selected = getSelectedSeries();
            
            if (selected.length === 0) {
                alert('LÃ¼tfen en az bir dizi seÃ§in!');
                return;
            }
            
            const statusDiv = document.getElementById('wordMapStatus');
            const statusText = document.getElementById('wordMapStatusText');
            const wordMapDiv = document.getElementById('seriesWordMap');
            
            statusDiv.style.display = 'block';
            statusText.innerHTML = '<span class="spinner"></span> Kelime haritasÄ± oluÅŸturuluyor... Bu iÅŸlem birkaÃ§ saniye sÃ¼rebilir.';
            wordMapDiv.style.display = 'none';
            
            try {
                const response = await fetch('/api/series/build-word-map', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ series: selected })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    let message = `âœ… Kelime haritasÄ± oluÅŸturuldu: ${data.unique_words.toLocaleString()} kelime, ${data.packages_created} seviye`;
                    if (data.translated_count && data.translated_count > 0) {
                        message += `<br>ğŸ¤– <strong>${data.translated_count}</strong> kelime Ã§evrildi!`;
                    } else {
                        message += `<br>ğŸ’¡ Kelimeleri Ã§evirmek iÃ§in aÅŸaÄŸÄ±daki seviyelerden "Ã‡evir" butonunu kullanÄ±n.`;
                    }
                    statusText.innerHTML = message;
                    statusText.style.color = '#15803d';
                    
                    // Kelime haritasÄ±nÄ± yÃ¼kle
                    await loadCombinedWordMap();
                } else {
                    statusText.innerHTML = `âŒ Hata: ${data.error || 'Bilinmeyen hata'}`;
                    statusText.style.color = '#dc2626';
                }
            } catch (error) {
                console.error('Error building word map:', error);
                statusText.innerHTML = `âŒ Hata: ${error.message}`;
                statusText.style.color = '#dc2626';
            }
        }

        // BirleÅŸik kelime haritasÄ±nÄ± yÃ¼kle (profil API'sini kullan)
        async function loadCombinedWordMap() {
            const userId = localStorage.getItem('user_id');
            const wordMapDiv = document.getElementById('seriesWordMap');
            const statsDiv = document.getElementById('seriesWordMapStats');
            const levelsDiv = document.getElementById('seriesWordMapLevels');
            
            try {
                let url = `/api/profile/word-map`;
                if (userId) {
                    url += `?user_id=${userId}`;
                }
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.success) {
                    // Ä°statistikleri gÃ¶ster
                    const summary = data.summary;
                    statsDiv.innerHTML = `
                        <div class="stat-box">
                            <div class="stat-box-number">${summary.total_words.toLocaleString()}</div>
                            <div class="stat-box-label">Toplam Kelime</div>
                        </div>
                        <div class="stat-box known">
                            <div class="stat-box-number">${summary.known_words.toLocaleString()}</div>
                            <div class="stat-box-label">Bilinen</div>
                            <div class="stat-box-percent">%${Math.round((summary.known_words / summary.total_words) * 100) || 0}</div>
                        </div>
                        <div class="stat-box unknown">
                            <div class="stat-box-number">${(summary.total_words - summary.known_words).toLocaleString()}</div>
                            <div class="stat-box-label">Ã–ÄŸrenilecek</div>
                        </div>
                    `;
                    
                    // Seviyeleri gÃ¶ster
                    if (data.levels && data.levels.length > 0) {
                        let levelsHtml = '';
                        data.levels.forEach(level => {
                            const known = data.progress[level.id] || 0;
                            const total = level.word_count;
                            const percent = total > 0 ? Math.round((known / total) * 100) : 0;
                            
                            let statusClass = 'low';
                            if (percent >= 80) statusClass = 'high';
                            else if (percent >= 40) statusClass = 'medium';
                            
                            const colorVar = statusClass === 'high' ? 'var(--secondary)' : (statusClass === 'medium' ? 'var(--warning)' : 'var(--danger)');
                            
                            levelsHtml += `
                                <div class="level-card">
                                    <div class="level-card-header">
                                        <div>
                                            <h3 class="level-card-title">${level.package_name}</h3>
                                            <div class="level-card-freq">Frekans: ${level.max_frequency} - ${level.min_frequency}</div>
                                        </div>
                                        <div class="level-card-percent ${statusClass}">%${percent}</div>
                                    </div>
                                    <div class="level-card-progress">
                                        <span>${known} / ${total} kelime</span>
                                    </div>
                                    <div class="level-card-bar">
                                        <div class="level-card-fill" style="width: ${percent}%; background-color: ${colorVar}"></div>
                                    </div>
                                </div>
                            `;
                        });
                        levelsDiv.innerHTML = levelsHtml;
                    }
                    
                    wordMapDiv.style.display = 'block';
                    
                    // Ã‡eviri istatistiklerini yÃ¼kle
                    if (typeof loadTranslationStats === 'function') {
                        loadTranslationStats();
                    }
                }
            } catch (error) {
                console.error('Error loading word map:', error);
            }
        }

        // Sezon transkriptlerini indirme fonksiyonu
        window.downloadSeasonTranscripts = async function() {
            const downloadBtn = document.getElementById('downloadTranscriptsBtn');
            const progressDiv = document.getElementById('downloadProgress');
            const progressText = document.getElementById('downloadProgressText');
            
            const series = downloadBtn.dataset.series;
            const season = downloadBtn.dataset.season;
            
            if (!series || !season) {
                alert('LÃ¼tfen Ã¶nce bir sezon seÃ§in!');
                return;
            }
            
            // Show progress
            downloadBtn.disabled = true;
            downloadBtn.textContent = 'â³ Ä°ndiriliyor...';
            progressDiv.style.display = 'block';
            progressText.textContent = `${series === 'friends' ? 'Friends' : 'Big Bang Theory'} Sezon ${season} transkriptleri indiriliyor...`;
            
            try {
                const response = await fetch(`/api/series/${series}/download-transcripts`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ season: parseInt(season) })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    progressDiv.style.background = '#d1fae5';
                    progressText.innerHTML = `âœ… ${data.message}`;
                    
                    if (data.failed && data.failed.length > 0) {
                        progressText.innerHTML += `<br><small style="color: #dc2626;">BaÅŸarÄ±sÄ±z bÃ¶lÃ¼mler: ${data.failed.join(', ')}</small>`;
                    }
                } else {
                    progressDiv.style.background = '#fee2e2';
                    progressText.textContent = `âŒ Hata: ${data.error}`;
                }
            } catch (error) {
                progressDiv.style.background = '#fee2e2';
                progressText.textContent = `âŒ BaÄŸlantÄ± hatasÄ±: ${error.message}`;
            }
            
            downloadBtn.disabled = false;
            downloadBtn.textContent = 'â¬‡ï¸ Transkriptleri Ä°ndir';
            
            // Hide progress after 10 seconds
            setTimeout(() => {
                progressDiv.style.display = 'none';
                progressDiv.style.background = '#fef3c7';
            }, 10000);
        }

        function selectSeries(series) {
            const episodeSelectionCard = document.getElementById('episodeSelectionCard');
            const seriesTitle = document.getElementById('selectedSeriesTitle');
            const seasonSelect = document.getElementById('seriesSeasonSelect');
            
            episodeSelectionCard.style.display = 'block';
            
            // BaÅŸlÄ±k gÃ¼ncelle
            if (series === 'friends') {
                seriesTitle.textContent = 'ğŸ‘« Friends - BÃ¶lÃ¼m SeÃ§imi';
            } else {
                seriesTitle.textContent = 'ğŸ§  Big Bang Theory - BÃ¶lÃ¼m SeÃ§imi';
            }

            // Ã–nce statik sezon listesini gÃ¶ster
            let seasons = [];
            if (series === 'friends') {
                seasons = [
                    { value: '1', label: 'Sezon 1 (24 bÃ¶lÃ¼m)' },
                    { value: '2', label: 'Sezon 2 (24 bÃ¶lÃ¼m)' },
                    { value: '3', label: 'Sezon 3 (25 bÃ¶lÃ¼m)' },
                    { value: '4', label: 'Sezon 4 (24 bÃ¶lÃ¼m)' },
                    { value: '5', label: 'Sezon 5 (24 bÃ¶lÃ¼m)' },
                    { value: '6', label: 'Sezon 6 (25 bÃ¶lÃ¼m)' },
                    { value: '7', label: 'Sezon 7 (24 bÃ¶lÃ¼m)' },
                    { value: '8', label: 'Sezon 8 (24 bÃ¶lÃ¼m)' },
                    { value: '9', label: 'Sezon 9 (24 bÃ¶lÃ¼m)' },
                    { value: '10', label: 'Sezon 10 (18 bÃ¶lÃ¼m)' }
                ];
            } else {
                seasons = [
                    { value: '1', label: 'Sezon 1 (17 bÃ¶lÃ¼m)' },
                    { value: '2', label: 'Sezon 2 (23 bÃ¶lÃ¼m)' },
                    { value: '3', label: 'Sezon 3 (23 bÃ¶lÃ¼m)' },
                    { value: '4', label: 'Sezon 4 (24 bÃ¶lÃ¼m)' },
                    { value: '5', label: 'Sezon 5 (24 bÃ¶lÃ¼m)' },
                    { value: '6', label: 'Sezon 6 (24 bÃ¶lÃ¼m)' },
                    { value: '7', label: 'Sezon 7 (24 bÃ¶lÃ¼m)' },
                    { value: '8', label: 'Sezon 8 (24 bÃ¶lÃ¼m)' },
                    { value: '9', label: 'Sezon 9 (24 bÃ¶lÃ¼m)' },
                    { value: '10', label: 'Sezon 10 (24 bÃ¶lÃ¼m)' },
                    { value: '11', label: 'Sezon 11 (24 bÃ¶lÃ¼m)' },
                    { value: '12', label: 'Sezon 12 (24 bÃ¶lÃ¼m)' }
                ];
            }
            
            // Statik sezon listesini hemen doldur
            seasonSelect.innerHTML = '<option value="">Sezon SeÃ§in</option>';
            seasons.forEach(s => {
                const option = document.createElement('option');
                option.value = s.value;
                option.textContent = s.label;
                seasonSelect.appendChild(option);
            });
            
            // BÃ¶lÃ¼m dropdown'Ä±nÄ± sÄ±fÄ±rla
            const episodeSelect = document.getElementById('seriesEpisodeSelect');
            episodeSelect.innerHTML = '<option value="">Ã–nce Sezon SeÃ§in</option>';
            episodeSelect.disabled = true;
            
            // Flashcard butonunu devre dÄ±ÅŸÄ± bÄ±rak
            document.getElementById('loadEpisodeFlashcardsBtn').disabled = true;
            document.getElementById('loadEpisodeFlashcardsBtn').dataset.series = series;
            
            // Transcript study butonunu da devre dÄ±ÅŸÄ± bÄ±rak
            const transcriptBtn = document.getElementById('openTranscriptStudyBtn');
            if (transcriptBtn) transcriptBtn.disabled = true;
            
            // Download butonunu da devre dÄ±ÅŸÄ± bÄ±rak
            const downloadBtn = document.getElementById('downloadTranscriptsBtn');
            if (downloadBtn) downloadBtn.disabled = true;
            
            // BÃ¶lÃ¼m bilgisi ve flashcard alanlarÄ±nÄ± gizle
            document.getElementById('episodeInfo').style.display = 'none';
            document.getElementById('flashcardsSection').style.display = 'none';
            document.getElementById('noFlashcardsMessage').style.display = 'none';
            
            // Scroll to episode selection
            episodeSelectionCard.scrollIntoView({ behavior: 'smooth' });
        }

        // Sezon seÃ§imi deÄŸiÅŸtiÄŸinde
        document.getElementById('seriesSeasonSelect').addEventListener('change', async function() {
            const season = this.value;
            const series = document.getElementById('loadEpisodeFlashcardsBtn').dataset.series;
            const episodeSelect = document.getElementById('seriesEpisodeSelect');
            const transcriptBtn = document.getElementById('openTranscriptStudyBtn');
            const downloadBtn = document.getElementById('downloadTranscriptsBtn');
            
            if (!season) {
                episodeSelect.innerHTML = '<option value="">Ã–nce Sezon SeÃ§in</option>';
                episodeSelect.disabled = true;
                document.getElementById('loadEpisodeFlashcardsBtn').disabled = true;
                if (transcriptBtn) transcriptBtn.disabled = true;
                if (downloadBtn) downloadBtn.disabled = true;
                return;
            }
            
            // Enable download button when season is selected
            if (downloadBtn) {
                downloadBtn.disabled = false;
                downloadBtn.dataset.series = series;
                downloadBtn.dataset.season = season;
            }
            
            // Statik bÃ¶lÃ¼m sayÄ±larÄ±
            let episodeCount = 24; // default
            if (series === 'friends') {
                const counts = { '1': 24, '2': 24, '3': 25, '4': 24, '5': 24, '6': 25, '7': 24, '8': 24, '9': 24, '10': 18 };
                episodeCount = counts[season] || 24;
            } else {
                const counts = { '1': 17, '2': 23, '3': 23, '4': 24, '5': 24, '6': 24, '7': 24, '8': 24, '9': 24, '10': 24, '11': 24, '12': 24 };
                episodeCount = counts[season] || 24;
            }
            
            // BÃ¶lÃ¼m dropdown'Ä±nÄ± doldur
            episodeSelect.innerHTML = '<option value="">BÃ¶lÃ¼m SeÃ§in</option>';
            for (let ep = 1; ep <= episodeCount; ep++) {
                const option = document.createElement('option');
                option.value = ep;
                option.textContent = `BÃ¶lÃ¼m ${ep}`;
                episodeSelect.appendChild(option);
            }
            episodeSelect.disabled = false;
        });

        // BÃ¶lÃ¼m seÃ§imi deÄŸiÅŸtiÄŸinde
        document.getElementById('seriesEpisodeSelect').addEventListener('change', function() {
            const episode = this.value;
            const loadBtn = document.getElementById('loadEpisodeFlashcardsBtn');
            const transcriptBtn = document.getElementById('openTranscriptStudyBtn');
            const series = document.getElementById('loadEpisodeFlashcardsBtn').dataset.series;
            const season = document.getElementById('seriesSeasonSelect').value;
            
            if (episode) {
                loadBtn.disabled = false;
                if (transcriptBtn) transcriptBtn.disabled = false;
                loadBtn.dataset.series = series;
                loadBtn.dataset.season = season;
                loadBtn.dataset.episode = episode;
            } else {
                loadBtn.disabled = true;
                if (transcriptBtn) transcriptBtn.disabled = true;
            }
        });

        // Flash KartlarÄ± Getir butonu - VeritabanÄ±ndan flash kartlarÄ± gÃ¶ster
        document.getElementById('loadEpisodeFlashcardsBtn').addEventListener('click', async function() {
            const series = this.dataset.series;
            const season = parseInt(this.dataset.season);
            const episode = parseInt(this.dataset.episode);
            const userId = localStorage.getItem('user_id');

            if (!series || !season || !episode) {
                alert('LÃ¼tfen sezon ve bÃ¶lÃ¼m seÃ§in!');
                return;
            }

            try {
                // VeritabanÄ±ndan flash kartlarÄ± getir (.db dosyasÄ±ndan)
                // KullanÄ±cÄ± ID'sini ekle (eÄŸer giriÅŸ yapÄ±lmÄ±ÅŸsa)
                let url = `/api/series/${series}/episodes/${season}/${episode}/flashcards`;
                if (window.currentUser && window.currentUser.user_id) {
                    url += `?user_id=${window.currentUser.user_id}`;
                }
                const response = await fetch(url);
                const data = await response.json();

                if (data.success) {
                    displayFlashcards(data);
                } else {
                    alert('Flashcard yÃ¼klenirken hata: ' + (data.error || 'Bu bÃ¶lÃ¼m iÃ§in kelime bulunamadÄ±'));
                }
            } catch (error) {
                console.error('Error loading flashcards:', error);
                alert('Flashcard yÃ¼klenirken hata: ' + error.message);
            }
        });

        // Find episode file name based on series, season, and episode
        async function findEpisodeFile(series, season, episode) {
            try {
                // Get list of subtitle files
                const response = await fetch('/api/subtitles/list');
                const data = await response.json();

                if (!data.success) return null;

                let folderName;
                let pattern;

                if (series === 'friends') {
                    folderName = 'friends_db';
                    // Files are named like: Friends - [7x01] - The One with Monica's Thunder.db
                    pattern = new RegExp(`${season}x${episode.toString().padStart(2, '0')}`, 'i');
                } else if (series === 'bigbang') {
                    folderName = 'BigBangTheory';
                    // Files are named like: series-1-episode-1-pilot-episode.txt
                    pattern = new RegExp(`series-${season}-episode-${episode}`, 'i');
                } else {
                    return null;
                }

                // Find files in the correct folder
                for (const file of data.files) {
                    if (file.season === folderName && pattern.test(file.name)) {
                        return file.name;
                    }
                }

                return null;
            } catch (error) {
                console.error('Error finding episode file:', error);
                return null;
            }
        }

        async function loadFlashcards(videoId, userId) {
            try {
                const response = await fetch(`/api/episodes/${videoId}/flashcards?user_id=${userId || ''}`);
                const data = await response.json();
                
                if (data.success) {
                    displayFlashcards(data);
                } else {
                    alert('Flashcard yÃ¼klenirken hata: ' + (data.error || 'Bilinmeyen hata'));
                }
            } catch (error) {
                console.error('Error loading flashcards:', error);
                alert('Flashcard yÃ¼klenirken hata: ' + error.message);
            }
        }

        // Flashcard'larÄ± gÃ¶rÃ¼ntÃ¼le
        function displayFlashcards(data) {
            const episodeInfo = document.getElementById('episodeInfo');
            const flashcardsSection = document.getElementById('flashcardsSection');
            const noFlashcardsMessage = document.getElementById('noFlashcardsMessage');
            
            // BÃ¶lÃ¼m bilgilerini gÃ¶ster
            const title = data.video ? data.video.title : (data.flashcards.length > 0 ? data.flashcards[0].word : "No words found");
            document.getElementById('episodeTitle').textContent = title;
            document.getElementById('episodeWordCount').textContent = data.flashcards.length;
            document.getElementById('episodeFlashcardCount').textContent = data.flashcards.length;
            
            // BildiÄŸim ve bilmediÄŸim kelime sayÄ±larÄ±nÄ± gÃ¶ster
            const knownCount = data.known_count !== undefined ? data.known_count : 0;
            const unknownCount = data.unknown_count !== undefined ? data.unknown_count : data.flashcards.length;
            document.getElementById('episodeKnownCount').textContent = knownCount;
            document.getElementById('episodeUnknownCount').textContent = unknownCount;
            
            
            // Seviye istatistiklerini gÃ¶ster (tÃ¼m kelimeler iÃ§in)
            const levelStatsContainer = document.getElementById('levelStatsContainer');
            const episodeLevelStats = document.getElementById('episodeLevelStats');
            
            // level_stats_all kullan (tÃ¼m kelimeler iÃ§in, seviye dÄ±ÅŸÄ± dahil)
            const statsToShow = data.level_stats_all || data.level_stats || {};
            
            if (statsToShow && Object.keys(statsToShow).length > 0) {
                levelStatsContainer.innerHTML = '';
                
                // Seviyeleri sÄ±ralÄ± gÃ¶ster (sayÄ±sal seviyeler Ã¶nce, sonra "Seviye DÄ±ÅŸÄ±")
                const sortedLevels = Object.keys(statsToShow).sort((a, b) => {
                    if (a === 'Seviye DÄ±ÅŸÄ±') return 1;
                    if (b === 'Seviye DÄ±ÅŸÄ±') return -1;
                    return parseInt(a) - parseInt(b);
                });
                
                sortedLevels.forEach(levelKey => {
                    const levelData = statsToShow[levelKey];
                    const levelCard = document.createElement('div');
                    levelCard.style.cssText = 'padding: 12px; background: #fff; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); border-left: 4px solid #667eea;';
                    
                    // Seviye renklerini ayarla
                    let borderColor = '#667eea';
                    if (levelData.level_number !== null && levelData.level_number !== undefined) {
                        const levelNum = parseInt(levelData.level_number);
                        if (levelNum <= 3) {
                            borderColor = '#ef4444'; // KÄ±rmÄ±zÄ±
                        } else if (levelNum <= 6) {
                            borderColor = '#f59e0b'; // Turuncu
                        } else if (levelNum <= 10) {
                            borderColor = '#3b82f6'; // Mavi
                        } else {
                            borderColor = '#10b981'; // YeÅŸil
                        }
                    } else {
                        borderColor = '#9ca3af'; // Gri - Seviye dÄ±ÅŸÄ±
                    }
                    
                    levelCard.style.borderLeftColor = borderColor;
                    levelCard.innerHTML = `
                        <div style="font-weight: 600; color: #374151; margin-bottom: 5px; font-size: 0.9em;">${levelData.level_name}</div>
                        <div style="font-size: 1.5em; font-weight: bold; color: ${borderColor};">${levelData.word_count}</div>
                        <div style="font-size: 0.75em; color: #6b7280; margin-top: 3px;">kelime</div>
                    `;
                    levelStatsContainer.appendChild(levelCard);
                });
                
                episodeLevelStats.style.display = 'block';
            } else {
                episodeLevelStats.style.display = 'none';
            }
            
            episodeInfo.style.display = 'block';
            
            if (data.flashcards.length === 0) {
                flashcardsSection.style.display = 'none';
                noFlashcardsMessage.style.display = 'block';
                return;
            }
            
            noFlashcardsMessage.style.display = 'none';
            flashcardsSection.style.display = 'block';
            
            // Flashcard state'ini ayarla
            window.currentFlashcards = data.flashcards;
            window.currentFlashcardIndex = 0;
            window.flashcardFlipped = false;
            
            updateFlashcardDisplay();
            updateFlashcardControls();
        }

        // Flashcard gÃ¶rÃ¼nÃ¼mÃ¼nÃ¼ gÃ¼ncelle
        function updateFlashcardDisplay() {
            if (!window.currentFlashcards || window.currentFlashcards.length === 0) return;
            
            const card = window.currentFlashcards[window.currentFlashcardIndex];
            const flashcard = document.getElementById('flashcard');
            
            if (!card || !flashcard) return;
            
            document.getElementById('flashcardWord').textContent = card.word || 'Kelime';
            document.getElementById('flashcardPronunciation').textContent = card.pronunciation || '';
            document.getElementById('flashcardDefinition').textContent = card.definition || '(Ã‡eviri henÃ¼z eklenmemiÅŸ - Kelime HaritasÄ±ndan "Ã‡evir" butonunu kullanÄ±n)';
            document.getElementById('flashcardFrequency').textContent = card.frequency ? `Frekans: ${card.frequency}` : '';
            
            // Seviye bilgisini gÃ¶ster
            const levelBadge = document.getElementById('flashcardLevelBadge');
            if (!levelBadge) {
                console.error('flashcardLevelBadge elementi bulunamadÄ±!');
                return;
            }
            
            // Seviye bilgisi kontrolÃ¼
            if (card.level_number !== null && card.level_number !== undefined && card.level_number !== 'Seviye DÄ±ÅŸÄ±') {
                const levelNum = parseInt(card.level_number);
                if (!isNaN(levelNum) && levelNum > 0) {
                    levelBadge.textContent = `Seviye ${levelNum}`;
                    levelBadge.style.display = 'block';
                    levelBadge.style.visibility = 'visible';
                    levelBadge.style.opacity = '1';
                    
                    // Seviye renklerini ayarla
                    if (levelNum <= 3) {
                        levelBadge.style.background = 'rgba(239, 68, 68, 0.6)'; // KÄ±rmÄ±zÄ± - BaÅŸlangÄ±Ã§
                        levelBadge.style.color = '#fff';
                    } else if (levelNum <= 6) {
                        levelBadge.style.background = 'rgba(245, 158, 11, 0.6)'; // Turuncu - Orta
                        levelBadge.style.color = '#fff';
                    } else if (levelNum <= 10) {
                        levelBadge.style.background = 'rgba(59, 130, 246, 0.6)'; // Mavi - Ä°leri
                        levelBadge.style.color = '#fff';
                    } else {
                        levelBadge.style.background = 'rgba(16, 185, 129, 0.6)'; // YeÅŸil - Uzman
                        levelBadge.style.color = '#fff';
                    }
                } else {
                    levelBadge.style.display = 'none';
                }
            } else if (card.level_name && card.level_name !== 'Seviye DÄ±ÅŸÄ±' && card.level_name !== undefined) {
                // Seviye adÄ± varsa gÃ¶ster
                levelBadge.textContent = card.level_name;
                levelBadge.style.display = 'block';
                levelBadge.style.visibility = 'visible';
                levelBadge.style.opacity = '1';
                levelBadge.style.background = 'rgba(255, 255, 255, 0.5)';
                levelBadge.style.color = '#fff';
            } else {
                // Seviye bilgisi yok - "Seviye DÄ±ÅŸÄ±" gÃ¶ster
                levelBadge.textContent = 'Seviye DÄ±ÅŸÄ±';
                levelBadge.style.display = 'block';
                levelBadge.style.visibility = 'visible';
                levelBadge.style.opacity = '1';
                levelBadge.style.background = 'rgba(156, 163, 175, 0.5)'; // Gri
                levelBadge.style.color = '#fff';
            }
            
            // KartÄ± baÅŸlangÄ±Ã§ durumuna Ã§evir (gÃ¶stermiyor)
            flashcard.style.transform = 'rotateY(0deg)';
            window.flashcardFlipped = false;
        }

        // Flashcard kontrollerini gÃ¼ncelle
        function updateFlashcardControls() {
            const total = window.currentFlashcards ? window.currentFlashcards.length : 0;
            const current = window.currentFlashcardIndex;
            
            document.getElementById('flashcardCounter').textContent = `${current + 1} / ${total}`;
            
            const prevBtn = document.getElementById('prevFlashcardBtn');
            const nextBtn = document.getElementById('nextFlashcardBtn');
            const markKnownBtn = document.getElementById('markKnownBtn');
            const markUnknownBtn = document.getElementById('markUnknownBtn');
            
            prevBtn.disabled = current === 0;
            nextBtn.disabled = current === total - 1;
            markKnownBtn.disabled = total === 0;
            markUnknownBtn.disabled = total === 0;
        }

        // KartÄ± Ã§evir
        document.getElementById('flashcard').addEventListener('click', function() {
            const flashcard = document.getElementById('flashcard');
            flashcard.style.transform = window.flashcardFlipped ? 'rotateY(0deg)' : 'rotateY(180deg)';
            window.flashcardFlipped = !window.flashcardFlipped;
        });

        // Ã–nceki/Sonraki kart
        document.getElementById('prevFlashcardBtn').addEventListener('click', () => {
            if (window.currentFlashcardIndex > 0) {
                window.currentFlashcardIndex--;
                updateFlashcardDisplay();
                updateFlashcardControls();
            }
        });

        document.getElementById('nextFlashcardBtn').addEventListener('click', () => {
            if (window.currentFlashcards && window.currentFlashcardIndex < window.currentFlashcards.length - 1) {
                window.currentFlashcardIndex++;
                updateFlashcardDisplay();
                updateFlashcardControls();
            }
        });

        // KarÄ±ÅŸtÄ±r
        document.getElementById('shuffleFlashcardsBtn').addEventListener('click', () => {
            if (!window.currentFlashcards) return;
            
            // Fisher-Yates shuffle
            for (let i = window.currentFlashcards.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [window.currentFlashcards[i], window.currentFlashcards[j]] = 
                [window.currentFlashcards[j], window.currentFlashcards[i]];
            }
            
            window.currentFlashcardIndex = 0;
            updateFlashcardDisplay();
            updateFlashcardControls();
        });

        // BaÅŸlat (ilk karta git)
        document.getElementById('startFlashcardsBtn').addEventListener('click', () => {
            window.currentFlashcardIndex = 0;
            updateFlashcardDisplay();
            updateFlashcardControls();
        });

        // Bilmiyorum/Biliyorum butonlarÄ±
        document.getElementById('markKnownBtn').addEventListener('click', async () => {
            await markFlashcard(true);
        });

        document.getElementById('markUnknownBtn').addEventListener('click', async () => {
            await markFlashcard(false);
        });

        async function markFlashcard(known) {
            // Check if user is logged in using currentUser (from app.js)
            if (!window.currentUser || !window.currentUser.user_id) {
                alert('LÃ¼tfen Ã¶nce giriÅŸ yapÄ±n!');
                // Try to show login section if available
                if (typeof showLoginSection === 'function') {
                    showLoginSection();
                }
                return;
            }
            
            if (!window.currentFlashcards || window.currentFlashcards.length === 0) return;
            
            const card = window.currentFlashcards[window.currentFlashcardIndex];
            
            try {
                const response = await fetch(`/api/words/${card.id}/mark`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: window.currentUser.user_id, known: known })
                });
                
                const data = await response.json();
                if (data.success) {
                    // KartÄ± listeden kaldÄ±r
                    window.currentFlashcards.splice(window.currentFlashcardIndex, 1);
                    
                    if (window.currentFlashcards.length === 0) {
                        // TÃ¼m kartlar bitti
                        document.getElementById('flashcardsSection').style.display = 'none';
                        document.getElementById('noFlashcardsMessage').style.display = 'block';
                        document.getElementById('episodeFlashcardCount').textContent = '0';
                        document.getElementById('episodeUnknownCount').textContent = '0';
                        // BildiÄŸim kelime sayÄ±sÄ±nÄ± gÃ¼ncelle
                        const knownCount = parseInt(document.getElementById('episodeKnownCount').textContent) + 1;
                        document.getElementById('episodeKnownCount').textContent = knownCount;
                    } else {
                        // AynÄ± index'teki sonraki karta geÃ§ (daha Ã¶nce silinenin yerine)
                        if (window.currentFlashcardIndex >= window.currentFlashcards.length) {
                            window.currentFlashcardIndex = window.currentFlashcards.length - 1;
                        }
                        updateFlashcardDisplay();
                        updateFlashcardControls();
                        document.getElementById('episodeFlashcardCount').textContent = window.currentFlashcards.length;
                        
                        // BildiÄŸim ve bilmediÄŸim kelime sayÄ±larÄ±nÄ± gÃ¼ncelle
                        if (known) {
                            const knownCount = parseInt(document.getElementById('episodeKnownCount').textContent) + 1;
                            const unknownCount = parseInt(document.getElementById('episodeUnknownCount').textContent) - 1;
                            document.getElementById('episodeKnownCount').textContent = knownCount;
                            document.getElementById('episodeUnknownCount').textContent = Math.max(0, unknownCount);
                        }
                    }
                }
            } catch (error) {
                console.error('Error marking word:', error);
            }
        }
    </script>

    <!-- Word Definition Popup -->
    <div id="wordDefinitionPopup" class="word-popup" style="display: none;">
        <div class="word-popup-arrow"></div>
        <div class="word-popup-content">
            <div class="word-popup-header">
                <span id="popupWord" class="popup-word"></span>
                <span id="popupPronunciation" class="popup-pronunciation"></span>
            </div>
            <div class="word-popup-body">
                <div id="popupDefinition" class="popup-definition">YÃ¼kleniyor...</div>
            </div>
            <div class="word-popup-footer">
                <button id="popupMarkKnown" class="btn btn-success btn-small" onclick="markWordFromPopup(true)">Biliyorum</button>
                <button id="popupMarkUnknown" class="btn btn-danger btn-small" onclick="markWordFromPopup(false)">Bilmiyorum</button>
            </div>
            <button id="closePopup" class="popup-close" onclick="closeWordPopup()">OK</button>
        </div>
    </div>

    <!-- Transcript Study Modal -->
    <div id="transcriptStudyModal" class="modal transcript-modal" style="display: none;">
        <div class="modal-content transcript-study-content">
            <div class="modal-header transcript-header">
                <h2 id="transcriptModalTitle">Transkript CalÄ±ÅŸma Modu</h2>
                <span class="close-modal" onclick="closeTranscriptStudyModal()">&times;</span>
            </div>
            <div class="transcript-controls">
                <div class="transcript-stats">
                    <span class="stat-item known-stat">
                        <span class="stat-icon">âœ…</span>
                        Bilinen (EÅŸsiz): <span id="transcriptKnownCount">0</span>
                    </span>
                    <span class="stat-item unknown-stat">
                        <span class="stat-icon">âŒ</span>
                        Bilinmeyen (EÅŸsiz): <span id="transcriptUnknownCount">0</span>
                    </span>
                    <span class="stat-item total-stat">
                        <span class="stat-icon">ğŸ“Š</span>
                        Toplam EÅŸsiz: <span id="transcriptTotalCount">0</span>
                    </span>
                </div>
                <div class="transcript-actions">
                    <button id="highlightUnknownBtn" class="btn btn-secondary btn-small" onclick="toggleUnknownHighlight()">
                        ğŸ”´ Bilinmeyenleri Vurgula
                    </button>
                    <button id="analyzeGrammarBtn" class="btn btn-secondary btn-small" onclick="toggleGrammarAnalysis()">
                        ğŸ“š Gramer Analizi
                    </button>
                    <button id="markAllKnownBtn" class="btn btn-success btn-small" onclick="markAllTranscriptWordsAsKnown()" title="Bu bÃ¶lÃ¼mdeki tÃ¼m kelimeleri bilinen olarak iÅŸaretle">
                        âœ… TÃ¼mÃ¼nÃ¼ Bilinen Yap
                    </button>
                </div>
            </div>
            <div class="transcript-info">
                <p>ğŸ’¡ <strong>KullanÄ±m:</strong> Kelimeye tÄ±klayarak anlamÄ±nÄ± gÃ¶rebilirsiniz. Gramer analizi iÃ§in transkriptten bir cÃ¼mleyi seÃ§in veya aÅŸaÄŸÄ±daki kutuya yazÄ±n.</p>
            </div>
            <div style="display: flex; flex-direction: row; flex: 1; min-height: 0; overflow: hidden; gap: 20px; padding: 0 25px;">
                <!-- Transcript Area - Left Side -->
                <div style="flex: 1; display: flex; flex-direction: column; min-height: 0;">
                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                        <span style="font-size: 1.3em; margin-right: 8px;">ğŸ“</span>
                        <h3 style="margin: 0; color: #1e40af; font-size: 1.1em; font-weight: 600;">Transkript</h3>
                    </div>
                    <div id="transcriptStudyContent" class="transcript-text" style="user-select: text; flex: 1; overflow-y: auto; min-height: 0; background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 8px; padding: 20px; font-size: 1.05em; line-height: 1.8;">
                        <!-- Interactive transcript will be loaded here -->
                    </div>
                </div>
                
                <!-- Grammar Analysis Panel - Right Side -->
                <div id="grammarAnalysisPanel" style="display: none; flex: 1; padding: 0; background: #f0f9ff; border: 2px solid #3b82f6; border-radius: 8px; flex-direction: column; overflow: hidden; min-height: 0; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; flex-shrink: 0; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; border-radius: 8px 8px 0 0;">
                        <div style="display: flex; align-items: center;">
                            <span style="font-size: 1.3em; margin-right: 10px;">ğŸ“š</span>
                            <h3 style="margin: 0; color: white; font-size: 1.2em; font-weight: 600;">Gramer Analizi</h3>
                        </div>
                        <button onclick="closeGrammarAnalysis()" style="background: rgba(255,255,255,0.2); border: none; font-size: 1.5em; cursor: pointer; color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: all 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">&times;</button>
                    </div>
                    <div id="grammarAnalysisContent" style="color: #1e293b; padding: 20px; flex: 1; overflow-y: auto; overflow-x: hidden; min-height: 0;">
                        <div style="background: #fff; border-radius: 8px; padding: 20px; margin-bottom: 15px; border: 1px solid #e2e8f0;">
                            <p style="margin: 0 0 15px 0; color: #64748b; font-size: 0.95em; line-height: 1.6;">
                                <strong style="color: #1e40af;">ğŸ’¡ NasÄ±l KullanÄ±lÄ±r:</strong><br>
                                1. Sol taraftaki transkriptten bir cÃ¼mleyi seÃ§in (fare ile sÃ¼rÃ¼kleyerek)<br>
                                2. SeÃ§ilen cÃ¼mle otomatik olarak aÅŸaÄŸÄ±daki kutuya gelecek<br>
                                3. Veya doÄŸrudan kutuya bir cÃ¼mle yazÄ±n<br>
                                4. "Analiz Et" butonuna tÄ±klayÄ±n
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Chatbot modal (Ã¼st Ã§ubuk ve floating buton script ile ekleniyor) -->
    <div id="chatbotModal" class="chatbot-modal-overlay" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.65);z-index:2147483646;align-items:center;justify-content:center;">
        <div class="chatbot-modal-box" style="background:#fff;border-radius:16px;max-width:800px;width:92%;height:82vh;max-height:780px;overflow:hidden;display:flex;flex-direction:column;box-shadow:0 25px 50px rgba(0,0,0,.25);">
            <div style="padding:18px 22px;background:linear-gradient(135deg,#6366f1,#8b5cf6);color:#fff;display:flex;justify-content:space-between;align-items:center;">
                <div><h2 style="margin:0;font-size:1.35em;">ğŸ¤– AI Ä°ngilizce Ã–ÄŸretmeni</h2><p style="margin:4px 0 0;font-size:.88em;opacity:.92;">Yerel AI ile Ä°ngilizce Ã¶ÄŸrenin</p></div>
                <button type="button" onclick="typeof closeChatbotModal==='function'&&closeChatbotModal()" style="background:rgba(255,255,255,.25);border:none;color:#fff;font-size:1.6em;cursor:pointer;width:38px;height:38px;border-radius:50%;display:flex;align-items:center;justify-content:center;">Ã—</button>
            </div>
            <div id="chatbotModalMessages" style="flex:1;overflow-y:auto;padding:18px;background:#f9fafb;">
                <div class="chat-message bot-message" style="margin-bottom:12px;padding:14px;background:#e0e7ff;border-radius:12px;max-width:85%;">
                    <div style="font-weight:600;color:#4338ca;margin-bottom:4px;">ğŸ¤– AI Ã–ÄŸretmen</div>
                    <div style="color:#1e293b;line-height:1.55;">Hello! I'm your English learning assistant. Ask about grammar, vocabulary, or practice. What would you like to learn today?</div>
                </div>
            </div>
            <div id="chatbotModalStatus" style="padding:10px 18px;background:#f3f4f6;border-top:1px solid #e5e7eb;font-size:.85em;color:#6b7280;text-align:center;"><span id="chatbotModalStatusText">HazÄ±rlanÄ±yorâ€¦</span></div>
            <div style="padding:14px 18px;background:#fff;border-top:2px solid #e5e7eb;display:flex;gap:10px;align-items:center;">
                <input type="text" id="chatbotModalInput" placeholder="MesajÄ±nÄ±zÄ± yazÄ±nâ€¦" style="flex:1;padding:12px 14px;border:2px solid #e5e7eb;border-radius:8px;font-size:1em;" onkeypress="if(event.key==='Enter')typeof sendChatbotModalMessage==='function'&&sendChatbotModalMessage()">
                <button type="button" id="chatbotModalSendBtn" onclick="typeof sendChatbotModalMessage==='function'&&sendChatbotModalMessage()" class="btn btn-primary" style="padding:12px 22px;border-radius:8px;white-space:nowrap;background:linear-gradient(135deg,#6366f1,#8b5cf6);border:none;">ğŸ“¤ GÃ¶nder</button>
                <button type="button" id="chatbotModalClearBtn" onclick="typeof clearChatbotModalHistory==='function'&&clearChatbotModalHistory()" class="btn btn-secondary" style="padding:12px 18px;border-radius:8px;" title="GeÃ§miÅŸi temizle">ğŸ—‘ï¸</button>
            </div>
        </div>
    </div>

    <!-- AI Ã–ÄŸretmen floating buton â€“ sadece alt kÄ±sÄ±mdaki baloncuk -->
    <script>
    (function(){ try {
      var z = 10000;
      // Sadece floating buton oluÅŸtur, Ã¼st Ã§ubuk yok
      var flt = document.createElement('button');
      flt.type = 'button';
      flt.id = 'floatingChatbotBtn';
      flt.innerHTML = 'ğŸ¤–';
      flt.title = 'AI Ä°ngilizce Ã–ÄŸretmeni';
      flt.style.cssText = 'position:fixed!important;bottom:28px!important;right:28px!important;width:68px!important;height:68px!important;border-radius:50%!important;background:linear-gradient(135deg,#6366f1,#8b5cf6)!important;border:none!important;color:#fff!important;font-size:32px!important;cursor:pointer!important;z-index:'+z+'!important;display:flex!important;align-items:center!important;justify-content:center!important;visibility:visible!important;opacity:1!important;box-shadow:0 4px 24px rgba(99,102,241,.5)!important;';
      flt.onclick = function(){ try { if(window.openChatbotModal) window.openChatbotModal(); } catch(e){} };
      document.body.appendChild(flt);
    } catch(e) { console.warn('Chatbot UI init:', e); }
    })();
    </script>
</body>
